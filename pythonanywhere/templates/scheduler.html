<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2c2c2c" />
  <title>Future Notes - Scheduler</title>
  <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png" />
  <link rel="favicon" type="image/x-icon" href="static/favicon.ico" />
  <link rel="manifest" href="static/site.webmanifest">
  <script src="/static/js/loader.js"></script>
  <script src="/static/js/check.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/rrule@2.7.1/dist/es5/rrule.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.8/index.global.min.js"></script>
  <script src="/static/js/calendar.js"></script>
  <style>
    /* ========= Existing Styles ========= */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: #e0e0e0;
    }
    /* Hide scrollbar for WebKit browsers */
    #add-modal::-webkit-scrollbar {
      display: none;
    }
    header {
        background-color: var(--hdr-color);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .desktop-nav {
      display: flex;
      gap: 20px;
      margin: 0 auto; /* This centers the nav container */
    }


    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: #f2f2f2;
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
    }
    .nav-link {
        position: relative;
        color: white;
        font-size: 18px;
        padding: 5px 0;
        transition: all 0.3s ease;
    }
    .nav-link::after {
      content: "";
      display: block;
      height: 2px;
      width: 0;
      background-color: transparent;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .nav-link:hover::after {
      width: 100%;
      background-color: lightgray;
    }
    .nav-link.active::after {
      width: 100%;
      background-color: white;
    }
    .homepage-link {
      text-decoration: none;
      background-color: var(--ctr-color);
      color: #e0e0e0;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
    }
    header a:hover {
      background-color: #5c5c5c;
    }
    /* Mobile Sub-Header - Hidden by default */
    .mobile-sub-header {
      display: none;
      background-color: var(--bg-color);
      padding: 10px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Mobile Nav Links */
    .mobile-sub-header a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 10px;
      font-size: 18px;
    }

    /* Active State */
    .mobile-sub-header a.active::after {
      content: "";
      display: block;
      height: 2px;
      width: 100%;
      background-color: white;
    }

    /* Hover effect */
    .mobile-sub-header a:hover::after {
      background-color: lightgray;
    }

    /* Toggle Button - hidden by default */
    .toggle-mobile-nav {
    background: none;
    border: none;
    color: #f2f2f2;
    font-size: 24px;
    cursor: pointer;
    display: none; /* Hidden by default */
    margin-right: 10px;
    }
    .toggle-mobile-nav:hover {
      background-color: none;
    }
    /* Desktop Nav - Visible on large screens */
    .desktop-nav {
      display: flex;
      gap: 20px;
    }
    /* Responsive Styles */
    @media (max-width: 600px) {
      .desktop-nav {
        display: none;
      }
      .toggle-mobile-nav {
        display: block;
      }
      header a {
        display: none;
      }
    }
    /* Main layout as flex container */
    main {
      padding: 40px 20px;
      max-width: 2000px;
      margin: 0 auto;
      display: flex;
      gap: 20px;
    }
    form {
      display: flex;
      margin-bottom: 30px;
      gap: 10px;
    }
    textarea,
    input[type="text"] {
      flex: 1;
      padding: 12px;
      font-size: 18px;
      background-color: var(--btn-color);
      color: #e0e0e0;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      resize: none;
    }
    textarea:focus,
    input[type="text"]:focus {
      background-color: #5a5a5a;
    }
    input#note-tag {
      max-width: 150px;
    }
    button {
      background-color: var(--btn-color);
      color: #e0e0e0;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #7a7a7a;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      animation: fadeIn 0.2s forwards 0.3s;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--hdr-color);
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      background-size: cover;
      background-position: center;
      position: absolute;
      right: 20px;
    }
    .profile-pic.no-picture {
      background-color: #cc4f4f;
      color: white;
    }
    /* Modal Styles for Login (existing) */
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #modal {
      background-color: var(--bg-color);
      padding: 20px 30px;
      border-radius: 12px;
      text-align: center;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }
    input,
    button {
      font-size: 16px;
      border-radius: 8px;
      padding: 10px;
    }
    #username,
    #password {
      width: calc(100% - 24px);
      margin: 10px 0;
      background-color: var(--btn-color);
      border: 1px solid #424242;
      color: #E0E0E0;
    }
    button #submit-credentials {
      background-color: var(--btn-color);
      color: #E0E0E0;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #616161;
    }
    

    #storage-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:2000; }
    #storage-modal .panel { width: 760px; max-width:96%; background: linear-gradient(90deg,#1b1b1b,#121212); color:white; border-radius:12px; padding:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 3px solid #ffcc00; }
    #storage-modal .header { display:flex; align-items:center; gap:12px; }
    #storage-modal .logo-badge { background:#ffcc00; color:#111; padding:8px 12px; border-radius:8px; font-weight:800; }
    #storage-modal .big { font-size:28px; font-weight:800; }
    #storage-modal .advert { margin-top:12px; background: linear-gradient(90deg,#ff7a18,#af002d); padding:12px; border-radius:8px; text-align:center; font-weight:700; }
    #storage-modal .invites { margin-top:16px; display:flex; gap:12px; }
    #storage-modal .invites .left, #storage-modal .invites .right { flex:1; }
    #storage-modal .input-row { display:flex; gap:8px; margin-top:8px; }
    #storage-modal .btn { padding:10px 14px; border-radius:8px; background:#333; color:white; border:none; cursor:pointer; }
    #storage-modal .btn.primary { background: linear-gradient(90deg,#ffcc00,#ff8a00); color:#111; font-weight:700; }
    #storage-modal .pending-list { max-height:220px; overflow:auto; margin-top:8px; border-top:1px solid rgba(255,255,255,0.06); padding-top:8px; }
    .almost-full { background: linear-gradient(90deg,#e74c3c,#c0392b) !important; }

    /* Container for counter + bar */
        #storage-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 200px;  /* adjust to your header size */
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 0 10px;
        }

        /* Text counter */
        #storage-counter {
            margin-bottom: 4px;
            font-weight: bold;
            color: #ffffff;
        }

        /* Background of progress bar */
        #storage-bar-bg {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        /* Filled portion */
        #storage-bar-fill {
            width: 0%; /* dynamically updated by JS */
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px 0 0 4px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        /* Infinite storage rainbow bar */
        /* Infinite storage rainbow bar */
        .infinite-storage {
            background-image: linear-gradient(
                270deg,
                #ff0000,
                #ff7f00,
                #ffff00,
                #00ff00,
                #0000ff,
                #4b0082,
                #8f00ff
            ) !important;
            background-size: 1400% 1400% !important;
            background-position: 0% 50% !important;
            animation: rainbowSlide 5s linear infinite !important;
        }

        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50% !important;
            }
            50% {
                background-position: 100% 50% !important;
            }
            100% {
                background-position: 0% 50% !important;
            }
        }
        .sidebar-calendar-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .sidebar-calendar-item:hover {
            background-color: var(--btn-color);
        }

        .sidebar-calendar-item.active-calendar {
            background-color: var(--btn-color);
            font-weight: bold;
        }

        #calendar-sidebar {
            background-color: var(--ctr-color);
            border-radius: 12px;
            padding: 12px;
        }

        /* layout basics */
        .layout-root {
            display: flex;
            gap: 12px;
            align-items: stretch;
            position: relative;
        }

        /* Sidebar default (desktop) */
        .calendar-sidebar {
            min-width: 260px;
            max-width: 320px;
            background: var(--sidebar-bg, #fff);
            border-radius: 8px;
            box-shadow: none;
            position: relative; /* static on desktop */
            z-index: 1;
        }

        /* inner wrapper so we can position the close button separately */
        .sidebar-inner { 
            position: relative; 
        }

        /* main content flex: take rest of width */
        .main-content {
            flex: 1;
            padding: 12px;
        }

        /* Close button inside the sliding sidebar (mobile) */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
        }

        /* Overlay ‚Äî initially hidden */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0; /* top/right/bottom/left 0 */
            z-index: 30;
            background: rgba(0,0,0,0.18);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px); /* Safari */
            pointer-events: none; /* enabled when open */
        }

        /* ================================
          Sidebar toggle button (mobile only)
          ================================ */

        /* Desktop: keep hidden */
        .sidebar-toggle {
            display: none;
        }

        /* Mobile: fixed pill attached to left edge at bottom */
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: flex;               /* visible on mobile */
                align-items: center;
                justify-content: center;
                position: fixed;
                left: 8px;                   /* glued to left side */
                bottom: 18px;                /* attached near bottom */
                z-index: 60;                 /* above most things */
                width: 48px;
                height: 48px;
                border-radius: 0 10px 10px 0;/* pill with rounded right edge */
                background: var(--btn-color);
                color: #fff;
                border: none;
                padding: 6px;
                box-shadow: 0 8px 20px rgba(0,0,0,0.28);
                cursor: pointer;
                transition: transform 180ms ease, opacity 180ms ease;
                -webkit-tap-highlight-color: transparent;
            }

            /* Small chevron inside button */
            .sidebar-toggle .chev {
                font-size: 20px;
                line-height: 1;
                display: inline-block;
                transform: translateX(1px);
            }

            /* show hamburger close button inside sidebar */
            .sidebar-close { 
                display: block; 
            }

            /* overlay visible, pointer-events toggled via JS */
            .sidebar-overlay {
                display: block;
                opacity: 0;
                transition: opacity 200ms ease;
            }

            /* sidebar becomes off-canvas by default */
            .calendar-sidebar {
                position: fixed;
                top: 0;
                left: -100%; /* hidden offscreen */
                height: 100%;
                width: min(88vw, 320px);
                max-width: 320px;
                min-width: 0;
                margin: 0;
                padding: 0;
                transition: left 260ms cubic-bezier(.2,.9,.2,1);
                z-index: 40; /* above overlay so it's visible */
                box-shadow: 0 8px 28px rgba(0,0,0,0.28);
                border-radius: 0 12px 12px 0;
            }

            /* when sidebar is open -> apply classes */
            .calendar-sidebar.open {
                left: 0;
            }
            .calendar-sidebar.open + .sidebar-overlay,
            .calendar-sidebar.open ~ .sidebar-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            /* Extra guard: hide toggle when sidebar is open (JS handles this, this is CSS backup) */
            .calendar-sidebar.open ~ .sidebar-toggle,
            .calendar-sidebar.open + .sidebar-toggle {
                opacity: 0;
                pointer-events: none;
                transform: translateX(-6px);
            }
        }

  </style>

  <script src="/static/admin.js"></script>
  <script src="/static/custom-alert.js"></script>
  <script src="/static/js/notifications.js"></script>

 <style>
  :root {
    --bg-color:  #2c2c2c;  /* defaults */
    --hdr-color: #3a3a3a;
    --ctr-color: #1e1e1e;
    --btn-color: #424242;
  }
</style>
<script>
  fetch("/user-colors")
            .then(res => {
                if (!res.ok) throw new Error("Could not load colors");
                return res.json();
            })
            .then(cfg => {
                document.documentElement.style.setProperty("--bg-color",   cfg.background_color);
                document.documentElement.style.setProperty("--hdr-color",  cfg.header_color);
                document.documentElement.style.setProperty("--ctr-color",  cfg.contrasting_color);
                document.documentElement.style.setProperty("--btn-color",  cfg.button_color);

                window.appConfig = {
                    backgroundColor:  cfg.background_color,
                    headerColor:      cfg.header_color,
                    contrastingColor: cfg.contrasting_color,
                    buttonColor:      cfg.button_color
                };
            })
            .catch(err => console.error(err));
</script>
</head>
<body>
  <header>
    <!-- Toggle button (only visible on mobile) -->
    <button id="toggle-mobile-nav" class="toggle-mobile-nav">‚ò∞</button>
    
    <a href="/" class="homepage-link"><h1>Future Notes</h1></a>
    
    <nav class="desktop-nav">
        <a href="/index" class="nav-link">Notes</a>
        <a href="/scheduler-page" class="nav-link active">Calendar</a>
        <a href="/todo_page" class="nav-link">Todo</a>
        <a href="/trello_page" class="nav-link">Trello</a>
    </nav>
    <div id="storage-container" style="margin: 0px 100px;">
        <span id="storage-counter">0 / 0 MB</span>
        <div id="storage-bar-bg">
            <div id="storage-bar-fill"></div>
        </div>
    </div>
    <div id="profile-pic" class="profile-pic no-picture"></div>
  </header>
  
  <nav id="mobileSubHeader" class="mobile-sub-header">
    <a href="/index" class="nav-link">Notes</a>
    <a href="/scheduler-page" class="nav-link active">Calendar</a>
    <a href="/todo_page" class="nav-link">Todo</a>
    <a href="/trello_page" class="nav-link">Trello</a>
  </nav>

  <div id="overlay"></div>

  <!-- Existing Login Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <h2>Session Expired</h2>
      <p>Please re-enter your username and password:</p>
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="submit-credentials">Submit</button>
    </div>
  </div>

  <div id="storage-modal" role="dialog" aria-hidden="true">
      <div class="panel" role="document">
          <div class="header">
          <div class="logo-badge">FUTURE NOTES</div>
          <div style="flex:1">
              <div class="big">Your storage ‚Äî make it bigger!</div>
              <div style="opacity:0.8">Store notes, files, memories. Invite friends to grow your quota.</div>
          </div>
          <div><button id="storage-modal-close" class="btn">‚úï</button></div>
          </div>

          <div class="advert">Invite friends ‚Üí get <strong>+5MB</strong> per verified signup. Limit: <span id="per-day-limit">3</span>/day. <span style="margin-left:12px">üéâ</span></div>

          <div class="invites">
          <div class="left">
              <h4>Current storage</h4>
              <div style="display:flex; align-items:center; gap:12px;">
              <div style="flex:1; background:#222; height:18px; border-radius:12px; padding:3px;">
                  <div id="storage-bar-fill-modal" style="width:0%; height:100%; border-radius:9px; background:linear-gradient(90deg,#ffd166,#ff8a00);"></div>
              </div>
              <div id="storage-counter-modal">0 / 0 MB</div>
              </div>

              <div style="margin-top:12px;">
              <h4>Invite someone</h4>
              <div>Remaining invites today: <strong id="remaining-today">3</strong></div>
              <div class="input-row">
                  <input id="invite-email" type="email" placeholder="friend@example.com" style="flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#0f0f0f; color:white;">
                  <button id="send-invite-btn" class="btn primary">Send Invite</button>
              </div>
              <div id="invite-feedback" style="margin-top:8px; color:#f1c40f;"></div>
              </div>
          </div>

          <div class="right">
              <h4>Pending invites</h4>
              <div class="pending-list" id="pending-invites-list">
              <div style="opacity:0.6">Loading...</div>
              </div>

              <h4 style="margin-top:12px;">Daily stats</h4>
              <div>Sent today: <strong id="sent-today">0</strong></div>
          </div>
          </div>
      </div>
  </div>

  <!-- Calendar UI with Sidebar -->
  <!-- Calendar container -->
<main class="layout-root">
  <!-- mobile-attached arrow toggle (mobile only styling below) -->
<button id="calendar-sidebar-toggle" class="sidebar-toggle" aria-expanded="false" aria-controls="calendar-sidebar" aria-label="Open calendar sidebar">
  <!-- right-pointing chevron ‚Äî indicates ‚Äúopen‚Äù since button sits at left edge -->
  <span class="chev" aria-hidden="true">‚ùØ</span>
</button>

  <aside id="calendar-sidebar" class="calendar-sidebar" aria-hidden="false">
    <div class="sidebar-inner">
      <button id="calendar-sidebar-close" class="sidebar-close" aria-label="Close sidebar">‚úï</button>

      <div style="padding:12px;">
        <h3 style="margin:0 0 10px 0;">My Calendars</h3>
        <div id="calendar-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <input id="new-calendar-name" placeholder="New calendar name" style="flex:1; padding:8px; border-radius:8px; background:var(--btn-color); color:#e0e0e0; border:none;">
          <button id="create-calendar-btn">Add</button>
        </div>

        <div style="margin-top:24px;">
          <button id="connect-google-btn">Connect Google</button>
          <div id="google-sync-controls" style="display:none;">
            <div style="margin-top:8px; font-size:13px; color:var(--text-muted);">
              Using Google calendar: <span id="google-calendar-name" style="font-weight:600">‚Äî</span>
            </div>
            <button id="sync-google-btn" style="margin-top:8px;">Sync ‚Üî Local</button>
            <button id="disconnect-google-btn" style="margin-top:8px;">Disconnect Google</button>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- overlay for mobile when sidebar open (handles blur + click-to-close) -->
  <div id="calendar-sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

  <section class="main-content">
    <div id="calendar" style="background:var(--ctr-color); border-radius:12px; padding:8px;"></div>
  </section>
</main>

<!-- Appointment modal (updated) -->
<div id="appt-modal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:4000;">
  <div style="width:720px; max-width:96%; background: linear-gradient(90deg,#1b1b1b,#121212); color:white; border-radius:12px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="modal-title">New appointment</h3>
      <button id="close-appt-modal">‚úï</button>
    </div>

    <div style="margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
      <input id="appt-title" placeholder="Title" style="padding:10px; border-radius:8px; background:var(--btn-color); color:#e0e0e0; border:none;">
      <!-- color control: swatch + color input + clear -->
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="appt-color" type="color" value="" style="width:44px; height:34px; padding:0; border-radius:6px; border:none;">
        <button id="clear-color-btn" type="button" title="Clear color" style="background:transparent; border:1px solid rgba(255,255,255,0.06); padding:6px 8px; border-radius:6px;">Clear</button>
        <div id="color-swatch-label" style="opacity:0.7; font-size:13px;">No color</div>
      </div>
      <textarea id="appt-desc" placeholder="Description" style="grid-column:1/3; padding:10px; border-radius:8px; background:var(--btn-color); color:#e0e0e0; border:none;"></textarea>
      <label>Start
        <input id="appt-start" type="datetime-local" style="width:100%; padding:8px; border-radius:8px; background:var(--btn-color); color:#e0e0e0; border:none;">
      </label>
      <label>End
        <input id="appt-end" type="datetime-local" style="width:100%; padding:8px; border-radius:8px; background:var(--btn-color); color:#e0e0e0; border:none;">
      </label>
      <label style="align-self:center;">
        <input id="appt-all-day" type="checkbox"> All day
      </label>

      <div style="grid-column:1/3; display:flex; align-items:center; gap:8px;">
        <label style="width:110px;">Recurrence</label>
        <select id="recurrence-simple" style="padding:6px; background:var(--btn-color); border-radius:6px;">
          <option value="">None</option>
          <option value="DAILY">Daily</option>
          <option value="WEEKLY">Weekly</option>
          <option value="MONTHLY">Monthly</option>
          <option value="YEARLY">Yearly</option>
        </select>
        <div style="margin-left:auto; color:rgba(255,255,255,0.7); font-size:13px;" id="rrule-preview">No recurrence</div>
      </div>

      <!-- Recurrence picker UI -->
      <div id="recurrence-advanced" style="grid-column:1/3; display:none; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px;">
        <div style="grid-column:1/3; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px;">
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="width:110px;">Recurrence</label>
            <select id="recurrence-freq" style="padding:6px; background:var(--btn-color); border-radius:6px;">
              <option value="">None</option>
              <option value="DAILY">Daily</option>
              <option value="WEEKLY">Weekly</option>
              <option value="MONTHLY">Monthly</option>
              <option value="YEARLY">Yearly</option>
            </select>

            <label style="margin-left:8px;">Every
              <input id="recurrence-interval" type="number" min="1" value="1" style="width:60px; margin-left:6px; padding:6px; border-radius:6px; background:var(--btn-color);">
            </label>

            <div id="weekly-weekdays" style="margin-left:12px; display:none;">
              <label><input type="checkbox" class="weekday" value="MO"> Mon</label>
              <label><input type="checkbox" class="weekday" value="TU"> Tue</label>
              <label><input type="checkbox" class="weekday" value="WE"> Wed</label>
              <label><input type="checkbox" class="weekday" value="TH"> Thu</label>
              <label><input type="checkbox" class="weekday" value="FR"> Fri</label>
              <label><input type="checkbox" class="weekday" value="SA"> Sat</label>
              <label><input type="checkbox" class="weekday" value="SU"> Sun</label>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <label>End:</label>
              <select id="recurrence-end-type" style="padding:6px; background:var(--btn-color); border-radius:6px;">
                <option value="never">Never</option>
                <option value="until">Until date</option>
                <option value="count">Count</option>
              </select>
              <input id="recurrence-until" type="date" style="display:none; padding:6px; border-radius:6px; background:var(--btn-color);">
              <input id="recurrence-count" type="number" min="1" value="10" style="display:none; width:80px; padding:6px; border-radius:6px; background:var(--btn-color);">
            </div>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <div style="flex:1; color:rgba(255,255,255,0.7); font-size:13px;" id="rrule-preview">RRULE preview will appear here</div>
            <button id="clear-recurrence">Clear</button>
          </div>
        </div>
      </div>

      <!-- Notes picker -->
      <div style="grid-column:1/3; margin-top:6px;">
        <label style="display:block; margin-bottom:6px;">Attach notes</label>
        <div id="notes-picker" style="max-height:160px; overflow:auto; padding:8px; background:var(--ctr-color); border-radius:8px;"></div>
      </div>

      <select id="appt-calendar" style="padding:8px; border-radius:8px; background:var(--btn-color); color:#e0e0e0;">
      </select>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="delete-appt-btn" style="display:none;">Delete</button>
      <button id="save-appt-btn" class="primary">Save</button>
    </div>
  </div>
</div>


</body>
</html>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
            // ensure fetch sends cookies
            if (!window.__fetchPatched) {
                const _f = window.fetch;
                window.fetch = (url, opts = {}) => {
                opts.credentials = 'include';
                return _f(url, opts);
                };
                window.__fetchPatched = true;
            }

            // ping a lightweight endpoint to check session
            async function validateSession() {
                try {
                const res = await fetch("/test-session", { method: "GET" });
                if (res.status === 200) {
                    updateStorageCounter();
                    window.calendarBootstrap();
                    return true;
                }
                if (res.status === 403) {
                    // banned
                    window.location.href = '/login_page?suspended=true';
                    return false;
                }
                // 401 or anything else ‚Üí try auto-login
                return false;
                } catch (err) {
                return false;
                }
            }

            // try auto-login via lasting_key cookie on the backend
            async function attemptAutoLogin() {
                try {
                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({})  // backend reads HTTP‚Äêonly cookie
                });
                if (res.ok) {
                    console.log("Auto-login successful");
                    updateStorageCounter();
                    window.calendarBootstrap();
                    return true;
                }
                // clear any stale lasting_key server‚Äëside‚Äîcookie remains but backend will reject next time
                showModal();
                return false;
                } catch (err) {
                showModal();
                return false;
                }
            }
            
        const ok = await validateSession();
        if (!ok) {
            await attemptAutoLogin();
        }
        });

    // Example: update the bar along with the text
        async function updateStorageCounter() {
          try {
              const res = await fetch('/user/storage');
              if (!res.ok) throw new Error("Failed to fetch storage info");
              const data = await res.json();

              const barHeader = document.getElementById('storage-bar-fill');

              let usedText, totalText, percentUsed;

              if (data.unlimited) {
                  usedText = "‚àû";
                  totalText = "Unlimited";
                  percentUsed = 100; // fill bar fully for effect
                  barHeader.classList.add('infinite-storage');
              } else {
                  usedText = (data.used_bytes / 1024 / 1024).toFixed(2);
                  totalText = (data.total_bytes / 1024 / 1024).toFixed(2);
                  percentUsed = Math.min((data.used_bytes / data.total_bytes) * 100, 100);
                  barHeader.classList.remove('infinite-storage');
              }

              document.getElementById('storage-counter').textContent = `${usedText} / ${totalText} MB`;
              document.getElementById('storage-bar-fill').style.width = `${percentUsed}%`;

              if (percentUsed > 90 && !data.unlimited) {
                  document.getElementById('storage-bar-fill').classList.add('almost-full');
              } else {
                  document.getElementById('storage-bar-fill').classList.remove('almost-full');
              }
          } catch (err) {
              console.error(err);
          }
      }


        document.getElementById('storage-container').style.cursor = 'pointer';
        document.getElementById('storage-container').addEventListener('click', openStorageModal);
        document.getElementById('storage-modal-close').addEventListener('click', closeStorageModal);
        document.getElementById('send-invite-btn').addEventListener('click', sendInvite)

        async function openStorageModal(e){
        e && e.preventDefault();
        document.getElementById('storage-modal').style.display = 'flex';
        await refreshModalData();
        }

        function closeStorageModal(){
        document.getElementById('storage-modal').style.display = 'none';
        document.getElementById('invite-feedback').textContent = '';
        }

        async function refreshModalData() {
            try {
                const res = await fetch('/invites/status');
                if (!res.ok) throw new Error('Failed to load status');
                const data = await res.json();

                const barModal = document.getElementById('storage-bar-fill-modal');

                let usedText, totalText, percent;

                if (data.total_mb === null || data.storage_message) {
                    usedText = "‚àû";
                    totalText = "Unlimited";
                    percent = 100; // fill bar fully for effect
                    barModal.classList.add('infinite-storage');
                } else {
                    usedText = data.used_mb.toFixed(2);
                    totalText = data.total_mb.toFixed(2);
                    percent = Math.min((data.used_mb / Math.max(data.total_mb, 1)) * 100, 100);
                    barModal.classList.remove('infinite-storage');
                }

                document.getElementById('storage-counter-modal').textContent = `${usedText} / ${totalText} MB`;
                document.getElementById('storage-bar-fill-modal').style.width = percent + '%';

                if (percent > 90 && !(data.total_mb === null || data.storage_message)) {
                    barModal.classList.add('almost-full');
                } else {
                    barModal.classList.remove('almost-full');
                }

                document.getElementById('remaining-today').textContent = data.remaining_today;
                document.getElementById('sent-today').textContent = data.sent_today;
                document.getElementById('per-day-limit').textContent = data.per_day_limit;

                const pendingList = document.getElementById('pending-invites-list');
                pendingList.innerHTML = '';
                if (!data.pending_invites || data.pending_invites.length === 0) {
                    pendingList.innerHTML = '<div style="opacity:0.6">No pending invites</div>';
                } else {
                    for (const p of data.pending_invites) {
                        const el = document.createElement('div');
                        el.style.padding = '8px';
                        el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                        el.innerHTML = `<div style="font-weight:700">${p.email}</div>
                                        <div style="opacity:0.6; font-size:12px">Sent ${new Date(p.created_at).toLocaleString()}</div>
                                        <button onclick="cancelInvite('${p.id}')" class="cancel-invite-btn">Cancel</button>`;
                        pendingList.appendChild(el);
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('invite-feedback').textContent = 'Could not load invite status.';
            }
        }


        async function sendInvite(){
        const email = document.getElementById('invite-email').value.trim();
        if (!email) {
            document.getElementById('invite-feedback').textContent = 'Enter an email first.';
            return;
        }
        document.getElementById('send-invite-btn').disabled = true;
        document.getElementById('invite-feedback').textContent = 'Sending...';

        try {
            const res = await fetch('/invites/send', {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({email})
            });
            const j = await res.json();
            if (!res.ok) {
            document.getElementById('invite-feedback').textContent = j.error || 'Failed to send';
            } else {
            document.getElementById('invite-feedback').textContent = 'Invite sent! They must sign up via the link to redeem.';
            document.getElementById('invite-email').value = '';
            // refresh
            await refreshModalData();
            }
        } catch (err) {
            console.error(err);
            document.getElementById('invite-feedback').textContent = 'Network error';
        } finally {
            document.getElementById('send-invite-btn').disabled = false;
        }
        }

    document.addEventListener("DOMContentLoaded", () => {
      const cfg = window.appConfig || {};
    
      const userColors = {
        bg:  cfg.backgroundColor,
        hdr: cfg.headerColor,
        ctr: cfg.contrastingColor,
        btn: cfg.buttonColor
      };
    
      // make it global
      window.userColors = userColors;
    
      // apply CSS custom properties
      const root = document.documentElement;
      root.style.setProperty("--bg-color",  userColors.bg);
      root.style.setProperty("--hdr-color", userColors.hdr);
      root.style.setProperty("--ctr-color", userColors.ctr);
      root.style.setProperty("--btn-color", userColors.btn);
    });

    window.onload = async () => {
      try {
        const response = await fetch("/test-session", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            
          },
        });
        if (response.status === 401) {
          showModal();
        } else {
          const userInfoResponse = await fetch("/user-info", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              
            },
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            const username = userInfo.username;
            const profilePic = userInfo.profile_picture;
            const profilePicElement = document.getElementById("profile-pic");
            if (profilePic) {
              const correctedProfilePic = profilePic.replace(/\\/g, "/");
              profilePicElement.style.backgroundImage = `url(${correctedProfilePic})`;
              profilePicElement.classList.remove("no-picture");
              profilePicElement.textContent = "";
            } else {
              profilePicElement.textContent = username[0].toUpperCase();
              profilePicElement.classList.add("no-picture");
            }
          } else {
            console.error("Failed to fetch user info");
          }
        }
      } catch (error) {
        console.error("Error during re-login:", error);
      }
    };
    document.getElementById("profile-pic").addEventListener("click", showAccountMenu);
    function showAccountMenu() {
      window.location.href = "/account_page";
    }
    sessionStorage.setItem("last_page", "/scheduler-page");
  </script>
</body>
</html>
