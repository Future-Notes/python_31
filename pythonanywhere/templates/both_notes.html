<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2c2c">
    <title>Future Notes - Notes</title>
    <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png">
    <link rel="favicon" type="image/x-icon" href="static/favicon.ico">
    <link rel="manifest" href="static/site.webmanifest">
    <script src="/static/js/loader.js"></script>
<style>
:root {
  --bg-color:  #2c2c2c;
  --ctr-color: #1e1e1e;
  --btn-color: #424242;
}

body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
        }

        header {
            background-color: var(--hdr-color);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: #f2f2f2;
        }

        nav {
            display: flex;
            gap: 20px;
        }

        nav a {
            text-decoration: none;
        }

        .nav-link {
            position: relative;
            color: white;
            font-size: 18px;
            padding: 5px 0;
            transition: all 0.3s ease;
        }

        .nav-link::after {
            content: "";
            display: block;
            height: 2px;
            width: 0;
            background-color: transparent;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
            background-color: lightgray;
        }

        .nav-link.active::after {
            width: 100%;
            background-color: white;
        }

        .homepage-link {
            text-decoration: none;
            background-color: var(--ctr-color);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
        }

        header a:hover {
            background-color: #5c5c5c;
        }

        .mobile-sub-header {
            display: none;
            background-color: var(--bg-color);
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: relative;
        }

        .mobile-sub-header a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px;
            font-size: 18px;
        }

        .mobile-sub-header a.active::after {
            content: "";
            display: block;
            height: 2px;
            width: 100%;
            background-color: white;
        }

        .mobile-sub-header a:hover::after {
            background-color: lightgray;
        }

        .desktop-nav {
            display: flex;
            gap: 20px;
            margin: 0 auto;
        }

        .toggle-mobile-nav {
            background: none;
            border: none;
            color: #f2f2f2;
            font-size: 24px;
            cursor: pointer;
            display: none;
            margin-right: 10px;
        }

        .mobile-header {
            display: none;
            align-items: center;
        }

        @media (max-width: 600px) {
            .desktop-nav {
                display: none;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .toggle-mobile-nav {
                display: block;
            }
            
            .homepage-link {
                display: none;
            }
            #storage-container {
                margin: 0 0 !important;
                margin-right: 166px !important;
            }
        }

/* Taskbar */
.tabs {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 1000;
  transition: transform 0.25s ease;
}
.tabs.hidden { transform: translateX(-50%) translateY(100%); }

.tab {
  background: var(--btn-color);
  color: #fff;
  padding: 10px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  transition: background 0.2s, transform 0.1s;
}
.tab:hover { background: var(--ctr-color); transform: translateY(-2px); }
.tab.active { background: var(--ctr-color); border: 2px solid var(--btn-color); }

/* Hover zone to track mouse near bottom */
.taskbar-hover-zone {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;  /* slightly larger than taskbar */
  height: 60px;
  pointer-events: none;
  background: rgba(0,0,0,0);
  z-index: 999;
}

/* Iframe containers */
.iframe-container {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  display: none;
}
.iframe-container.active { display: flex; }
iframe {
  flex: 1;
  width: 100%;
  height: 100%;
  border: none;
  background-color: var(--ctr-color);
}

/* Split view */
.split {
  display: flex;
  width: 100%;
  height: 100%;
  position: relative;
}
.split iframe { flex: 1 1 50%; height: 100%; }
.resizer {
  width: 6px;
  cursor: ew-resize;
  background-color: var(--btn-color);
  z-index: 2;
}

/* Container for counter + bar */
        #storage-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 200px;  /* adjust to your header size */
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 0 10px;
        }

        /* Text counter */
        #storage-counter {
            margin-bottom: 4px;
            font-weight: bold;
            color: #ffffff;
        }

        /* Background of progress bar */
        #storage-bar-bg {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        /* Filled portion */
        #storage-bar-fill {
            width: 0%; /* dynamically updated by JS */
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px 0 0 4px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        /* Red when almost full */
        #storage-bar-fill.almost-full {
            background: linear-gradient(90deg, #ffb74d , #e53935);
        }

        #storage-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:2000; }
        #storage-modal .panel { width: 760px; max-width:96%; background: linear-gradient(90deg,#1b1b1b,#121212); color:white; border-radius:12px; padding:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 3px solid #ffcc00; }
        #storage-modal .header { display:flex; align-items:center; gap:12px; }
        #storage-modal .logo-badge { background:#ffcc00; color:#111; padding:8px 12px; border-radius:8px; font-weight:800; }
        #storage-modal .big { font-size:28px; font-weight:800; }
        #storage-modal .advert { margin-top:12px; background: linear-gradient(90deg,#ff7a18,#af002d); padding:12px; border-radius:8px; text-align:center; font-weight:700; }
        #storage-modal .invites { margin-top:16px; display:flex; gap:12px; }
        #storage-modal .invites .left, #storage-modal .invites .right { flex:1; }
        #storage-modal .input-row { display:flex; gap:8px; margin-top:8px; }
        #storage-modal .btn { padding:10px 14px; border-radius:8px; background:#333; color:white; border:none; cursor:pointer; }
        #storage-modal .btn.primary { background: linear-gradient(90deg,#ffcc00,#ff8a00); color:#111; font-weight:700; }
        #storage-modal .pending-list { max-height:220px; overflow:auto; margin-top:8px; border-top:1px solid rgba(255,255,255,0.06); padding-top:8px; }
        .almost-full { background: linear-gradient(90deg,#e74c3c,#c0392b) !important; }
        
        /* Infinite storage rainbow bar */
        .infinite-storage {
            background-image: linear-gradient(
                270deg,
                #ff0000,
                #ff7f00,
                #ffff00,
                #00ff00,
                #0000ff,
                #4b0082,
                #8f00ff
            ) !important;
            background-size: 1400% 1400% !important;
            background-position: 0% 50% !important;
            animation: rainbowSlide 5s linear infinite !important;
        }

        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50% !important;
            }
            50% {
                background-position: 100% 50% !important;
            }
            100% {
                background-position: 0% 50% !important;
            }
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #modal {
            background-color: var(--ctr-color);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
        }

        #username, #password {
            width: calc(100% - 24px);
            margin: 10px 0;
            background-color: var(--btn-color);
            border: 1px solid #424242;
            color: #E0E0E0;
            padding: 10px;
            border-radius: 8px;
        }

        input {
            background-color: var(--btn-color);
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            outline: none;
            transition: background-color 0.2s;
        }

        button {
            background-color: var(--btn-color);
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input:focus {
            background-color: #5a5a5a;
        }

        button:hover {
            background-color: #616161;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--hdr-color);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }
        
        .profile-pic.no-picture {
            background-color: #cc4f4f;
            color: white;
            border-radius: 50%;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            animation: fadeIn 0.2s forwards 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
</style>
<script src="/static/custom-alert.js"></script>
<script src="/static/admin.js"></script>
<script src="/static/js/notifications.js"></script>
<style>
        :root {
            --bg-color:  #2c2c2c;
            --hdr-color: #3a3a3a;
            --ctr-color: #1e1e1e;
            --btn-color: #424242;
        }
    </style>

    <script>
        fetch("/user-colors")
            .then(res => {
                if (!res.ok) throw new Error("Could not load colors");
                return res.json();
            })
            .then(cfg => {
                document.documentElement.style.setProperty("--bg-color", cfg.background_color);
                document.documentElement.style.setProperty("--hdr-color", cfg.header_color);
                document.documentElement.style.setProperty("--ctr-color", cfg.contrasting_color);
                document.documentElement.style.setProperty("--btn-color", cfg.button_color);

                window.appConfig = {
                    backgroundColor: cfg.background_color,
                    headerColor: cfg.header_color,
                    contrastingColor: cfg.contrasting_color,
                    buttonColor: cfg.button_color
                };
            })
            .catch(err => console.error(err));
    </script>
</head>
<body>

<header>
        <div class="mobile-header">
            <button id="toggle-mobile-nav" class="toggle-mobile-nav">â˜°</button>
            <input type="password" style="position: absolute; left: -9999px; opacity: 0;">
        </div>
      
        <a href="/" class="homepage-link"><h1>Future Notes</h1></a>
        <nav class="desktop-nav">
            <a href="/index" class="nav-link active">Notes</a>
            <a href="/scheduler-page" class="nav-link">Calendar</a>
            <a href="/todo_page" class="nav-link">Todo</a>
            <a href="/trello_page" class="nav-link">Trello</a>
        </nav>
        <div id="storage-container" style="margin: 0px 100px;">
            <span id="storage-counter">0 / 0 MB</span>
            <div id="storage-bar-bg">
                <div id="storage-bar-fill"></div>
            </div>
        </div>
        <div id="profile-pic" class="profile-pic no-picture"></div>
    </header>
      
    <nav id="mobileSubHeader" class="mobile-sub-header">
        <a href="/index" class="nav-link active">Notes</a>
        <a href="/scheduler-page" class="nav-link">Calendar</a>
        <a href="/todo_page" class="nav-link">Todo</a>
        <a href="/trello_page" class="nav-link">Trello</a>
    </nav>

<div id="storage-modal" role="dialog" aria-hidden="true">
        <div class="panel" role="document">
            <div class="header">
            <div class="logo-badge">FUTURE NOTES</div>
            <div style="flex:1">
                <div class="big">Your storage â€” make it bigger!</div>
                <div style="opacity:0.8">Store notes, files, memories. Invite friends to grow your quota.</div>
            </div>
            <div><button id="storage-modal-close" class="btn">âœ•</button></div>
            </div>

            <div class="advert">Invite friends â†’ get <strong>+5MB</strong> per verified signup. Limit: <span id="per-day-limit">3</span>/day. <span style="margin-left:12px">ðŸŽ‰</span></div>

            <div class="invites">
            <div class="left">
                <h4>Current storage</h4>
                <div style="display:flex; align-items:center; gap:12px;">
                <div style="flex:1; background:#222; height:18px; border-radius:12px; padding:3px;">
                    <div id="storage-bar-fill-modal" style="width:0%; height:100%; border-radius:9px; background:linear-gradient(90deg,#ffd166,#ff8a00);"></div>
                </div>
                <div id="storage-counter-modal">0 / 0 MB</div>
                </div>

                <div style="margin-top:12px;">
                <h4>Invite someone</h4>
                <div>Remaining invites today: <strong id="remaining-today">3</strong></div>
                <div class="input-row">
                    <input id="invite-email" type="email" placeholder="friend@example.com" style="flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#0f0f0f; color:white;">
                    <button id="send-invite-btn" class="btn primary">Send Invite</button>
                </div>
                <div id="invite-feedback" style="margin-top:8px; color:#f1c40f;"></div>
                </div>
            </div>

            <div class="right">
                <h4>Pending invites</h4>
                <div class="pending-list" id="pending-invites-list">
                <div style="opacity:0.6">Loading...</div>
                </div>

                <h4 style="margin-top:12px;">Daily stats</h4>
                <div>Sent today: <strong id="sent-today">0</strong></div>
            </div>
            </div>
        </div>
    </div>

<!-- Hover zone for taskbar -->
<div class="taskbar-hover-zone" id="hoverZone"></div>

<!-- Tabs / floating taskbar -->
<div class="tabs" id="tabs">
  <div class="tab active" onclick="showTab('personal')">Personal</div>
  <div class="tab" onclick="showTab('group')">Groups</div>
  <div class="tab" onclick="showTab('both')">Split View</div>
</div>

<!-- Iframe containers (lazy loading) -->
<div id="personal" class="iframe-container active">
  <iframe id="iframe-personal" data-src="/notes_page"></iframe>
</div>
<div id="group" class="iframe-container">
  <iframe id="iframe-group" data-src="/group-notes"></iframe>
</div>
<div id="both" class="iframe-container">
  <div class="split">
    <iframe id="iframe-split-left" data-src="/notes_page"></iframe>
    <div class="resizer"></div>
    <iframe id="iframe-split-right" data-src="/group-notes"></iframe>
  </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", async () => {
  // Ensure fetch sends cookies
  if (!window.__fetchPatched) {
      const _f = window.fetch;
      window.fetch = (url, opts = {}) => {
          opts.credentials = 'include';
          return _f(url, opts);
      };
      window.__fetchPatched = true;
  }
    // Listen for iframe alert messages
    window.addEventListener("message", (event) => {
        if (!event.data || event.data.from !== "iframe-alert") return;

        // Trigger parentâ€™s alert system (this fileâ€™s own patched alert)
        alert(event.data.message, event.data.type, event.data.timeout);
    });


  // Ping to check session
  async function validateSession() {
      try {
          const res = await fetch("/test-session", { method: "GET" });
          if (res.status === 200) {
              updateStorageCounter();
              loadUserProfile();
              return true;
          }
          if (res.status === 403) {
              window.location.href = '/login_page?suspended=true';
              return false;
          }
          return false;
      } catch (err) {
          return false;
      }
  }

  // Try auto-login
  async function attemptAutoLogin() {
      try {
          const res = await fetch("/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({})
          });
          if (res.ok) {
              updateStorageCounter();
              loadUserProfile();
              return true;
          }
          showModal();
          return false;
      } catch (err) {
          showModal();
          return false;
      }
  }

  const ok = await validateSession();
  if (!ok) {
      await attemptAutoLogin();
  }
  });
  async function updateStorageCounter() {
            try {
                const res = await fetch('/user/storage');
                if (!res.ok) throw new Error("Failed to fetch storage info");
                const data = await res.json();

                const barHeader = document.getElementById('storage-bar-fill');

                let usedText, totalText, percentUsed;

                if (data.unlimited) {
                    usedText = "âˆž";
                    totalText = "Unlimited";
                    percentUsed = 100; // fill bar fully for effect
                    barHeader.classList.add('infinite-storage');
                } else {
                    usedText = (data.used_bytes / 1024 / 1024).toFixed(2);
                    totalText = (data.total_bytes / 1024 / 1024).toFixed(2);
                    percentUsed = Math.min((data.used_bytes / data.total_bytes) * 100, 100);
                    barHeader.classList.remove('infinite-storage');
                }

                document.getElementById('storage-counter').textContent = `${usedText} / ${totalText} MB`;
                document.getElementById('storage-bar-fill').style.width = `${percentUsed}%`;

                if (percentUsed > 90 && !data.unlimited) {
                    document.getElementById('storage-bar-fill').classList.add('almost-full');
                } else {
                    document.getElementById('storage-bar-fill').classList.remove('almost-full');
                }
            } catch (err) {
                console.error(err);
            }
        }


        document.getElementById('storage-container').style.cursor = 'pointer';
        document.getElementById('storage-container').addEventListener('click', openStorageModal);
        document.getElementById('storage-modal-close').addEventListener('click', closeStorageModal);
        document.getElementById('send-invite-btn').addEventListener('click', sendInvite)

        async function openStorageModal(e){
        e && e.preventDefault();
        document.getElementById('storage-modal').style.display = 'flex';
        await refreshModalData();
        }

        function closeStorageModal(){
        document.getElementById('storage-modal').style.display = 'none';
        document.getElementById('invite-feedback').textContent = '';
        }

        async function refreshModalData() {
            try {
                const res = await fetch('/invites/status');
                if (!res.ok) throw new Error('Failed to load status');
                const data = await res.json();

                const barModal = document.getElementById('storage-bar-fill-modal');

                let usedText, totalText, percent;

                if (data.total_mb === null || data.storage_message) {
                    usedText = "âˆž";
                    totalText = "Unlimited";
                    percent = 100; // fill bar fully for effect
                    barModal.classList.add('infinite-storage');
                } else {
                    usedText = data.used_mb.toFixed(2);
                    totalText = data.total_mb.toFixed(2);
                    percent = Math.min((data.used_mb / Math.max(data.total_mb, 1)) * 100, 100);
                    barModal.classList.remove('infinite-storage');
                }

                document.getElementById('storage-counter-modal').textContent = `${usedText} / ${totalText} MB`;
                document.getElementById('storage-bar-fill-modal').style.width = percent + '%';

                if (percent > 90 && !(data.total_mb === null || data.storage_message)) {
                    barModal.classList.add('almost-full');
                } else {
                    barModal.classList.remove('almost-full');
                }

                document.getElementById('remaining-today').textContent = data.remaining_today;
                document.getElementById('sent-today').textContent = data.sent_today;
                document.getElementById('per-day-limit').textContent = data.per_day_limit;

                const pendingList = document.getElementById('pending-invites-list');
                pendingList.innerHTML = '';
                if (!data.pending_invites || data.pending_invites.length === 0) {
                    pendingList.innerHTML = '<div style="opacity:0.6">No pending invites</div>';
                } else {
                    for (const p of data.pending_invites) {
                        const el = document.createElement('div');
                        el.style.padding = '8px';
                        el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                        el.innerHTML = `<div style="font-weight:700">${p.email}</div>
                                        <div style="opacity:0.6; font-size:12px">Sent ${new Date(p.created_at).toLocaleString()}</div>
                                        <button onclick="cancelInvite('${p.id}')" class="cancel-invite-btn">Cancel</button>`;
                        pendingList.appendChild(el);
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('invite-feedback').textContent = 'Could not load invite status.';
            }
        }


        async function sendInvite(){
        const email = document.getElementById('invite-email').value.trim();
        if (!email) {
            document.getElementById('invite-feedback').textContent = 'Enter an email first.';
            return;
        }
        document.getElementById('send-invite-btn').disabled = true;
        document.getElementById('invite-feedback').textContent = 'Sending...';

        try {
            const res = await fetch('/invites/send', {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({email})
            });
            const j = await res.json();
            if (!res.ok) {
            document.getElementById('invite-feedback').textContent = j.error || 'Failed to send';
            } else {
            document.getElementById('invite-feedback').textContent = 'Invite sent! They must sign up via the link to redeem.';
            document.getElementById('invite-email').value = '';
            // refresh
            await refreshModalData();
            }
        } catch (err) {
            console.error(err);
            document.getElementById('invite-feedback').textContent = 'Network error';
        } finally {
            document.getElementById('send-invite-btn').disabled = false;
        }
        }

document.addEventListener("DOMContentLoaded", function() {
            const toggleButton = document.getElementById("toggle-mobile-nav");
            const mobileNav = document.getElementById("mobileSubHeader");

            toggleButton.addEventListener("click", function() {
                if (mobileNav.style.display === "block") {
                    mobileNav.style.display = "none";
                } else {
                    mobileNav.style.display = "block";
                }
            });
        });

document.getElementById("profile-pic").addEventListener("click", () => {
            window.location.href = "/account_page";
        });


  async function loadUserProfile() {
  try {
      const userInfoResponse = await fetch("/user-info");
      if (userInfoResponse.ok) {
          const userInfo = await userInfoResponse.json();
          const profilePicElement = document.getElementById("profile-pic");
          
          if (userInfo.profile_picture) {
              const correctedProfilePic = userInfo.profile_picture.replace(/\\/g, "/");
              profilePicElement.style.backgroundImage = `url(${correctedProfilePic})`;
              profilePicElement.classList.remove("no-picture");
              profilePicElement.textContent = "";
          } else {
              profilePicElement.textContent = userInfo.username[0].toUpperCase();
              profilePicElement.classList.add("no-picture");
          }
      }
  } catch (error) {
      console.error("Error loading user profile:", error);
  }
  }

  function showModal() {
      window.location.href = '/login_page?redirect=/index&warning=true';
  }

  function hideModal() {
      const modalOverlay = document.getElementById("modal-overlay");
      modalOverlay.style.display = "none";
      document.getElementById("floating-add-button").style.display = "flex";
  }

const allowedIframeUrls = [
    '/notes_page',
    '/group-notes'
];

function monitorIframeNavigation(iframeId) {
  const iframe = document.getElementById(iframeId);

  iframe.addEventListener('load', () => {
    try {
      // Get the iframe's current URL
      const iframeUrl = iframe.contentWindow.location.pathname;
      
      // If it's not one of the allowed URLs, navigate the parent
      if(!allowedIframeUrls.includes(iframeUrl)) {
        console.log(`Iframe navigated to ${iframeUrl}, redirecting parent.`);
        window.location.href = iframe.contentWindow.location.href;
      }
    } catch (e) {
      // Catch cross-origin errors (if the iframe navigates to a completely different domain)
      // Just navigate the parent anyway
      window.location.href = iframe.src;
    }
  });
}

// Apply to all your iframes
['iframe-personal','iframe-group','iframe-split-left','iframe-split-right'].forEach(id => {
  monitorIframeNavigation(id);
});


// ------------------- Tab handling & lazy load -------------------
function loadIframe(id) {
  const iframe = document.getElementById(id);
  if(!iframe.src) iframe.src = iframe.dataset.src;
}

function pauseIframe(id) {
  const iframe = document.getElementById(id);
  if(iframe.contentWindow) iframe.contentWindow.postMessage('pause', '*');
}

function resumeIframe(id) {
  const iframe = document.getElementById(id);
  if(iframe.contentWindow) iframe.contentWindow.postMessage('resume', '*');
}

function showTab(tab, event) {
  document.querySelectorAll('.iframe-container').forEach(c => c.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if(event) event.target.classList.add('active');

  // Experimental warning for split view
  if(tab === 'both' && !localStorage.getItem('splitViewWarningShown')){
    alert("âš ï¸ Split view is experimental! Some features may not work perfectly.", "error");
    localStorage.setItem('splitViewWarningShown', 'true');
  }

  // Lazy load
  if(tab === 'personal') loadIframe('iframe-personal');
  if(tab === 'group') loadIframe('iframe-group');
  if(tab === 'both'){
    loadIframe('iframe-split-left');
    loadIframe('iframe-split-right');
  }

  // Focus / pause handling
  ['iframe-personal','iframe-group','iframe-split-left','iframe-split-right'].forEach(id => {
    if(document.getElementById(id).closest('.iframe-container').id === tab){
      resumeIframe(id);
    } else {
      pauseIframe(id);
    }
  });
}

// Auto-load default tab with a null event
showTab('personal', null);

const isMobile = window.matchMedia("(max-width: 600px)").matches;
if(isMobile){
  // hide or disable the "Split View" tab
  const splitTab = document.querySelector('.tab[onclick*="both"]');
  if(splitTab) splitTab.style.display = 'none';
}


// ------------------- Floating taskbar auto-hide -------------------
const tabs = document.getElementById('tabs');
const hoverZone = document.getElementById('hoverZone');

// ------------------- Split view resizer -------------------
const resizer = document.querySelector('.resizer');
if(resizer){
  const left = resizer.previousElementSibling;
  const right = resizer.nextElementSibling;
  let isResizing = false;

  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.zIndex = 5;
  overlay.style.cursor = 'ew-resize';

  resizer.addEventListener('mousedown', e => {
    isResizing = true;
    document.body.appendChild(overlay);
  });

  document.addEventListener('mousemove', e => {
    if(!isResizing) return;
    const containerWidth = resizer.parentElement.getBoundingClientRect().width;
    let newLeftWidth = e.clientX / containerWidth;
    newLeftWidth = Math.max(0.1, Math.min(0.9, newLeftWidth));
    left.style.flex = `${newLeftWidth} 1 0%`;
    right.style.flex = `${1 - newLeftWidth} 1 0%`;
  });

  document.addEventListener('mouseup', () => {
    if(isResizing){
      isResizing = false;
      if(overlay.parentElement) overlay.parentElement.removeChild(overlay);
    }
  });
}
sessionStorage.setItem("last_page", "/index");
</script>
</body>
</html>
