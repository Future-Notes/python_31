<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2c2c2c" />
  <title>Future Notes - Todo</title>
  <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png" />
  <link rel="favicon" type="image/x-icon" href="static/favicon.ico" />
  <link rel="manifest" href="static/site.webmanifest">
  <script src="/static/js/loader.js"></script>
  <script src="/static/js/check.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: #e0e0e0;
    }

    header {
      background-color: var(--hdr-color);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .desktop-nav {
      display: flex;
      gap: 20px;
      margin: 0 auto; /* This centers the nav container */
    }


    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: #f2f2f2;
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
    }
    .nav-link {
        position: relative;
        color: white;
        font-size: 18px;
        padding: 5px 0;
        transition: all 0.3s ease;
    }
    .nav-link::after {
      content: "";
      display: block;
      height: 2px;
      width: 0;
      background-color: transparent;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .nav-link:hover::after {
      width: 100%;
      background-color: lightgray;
    }
    .nav-link.active::after {
      width: 100%;
      background-color: white;
    }
    .homepage-link {
      text-decoration: none;
      background-color: var(--ctr-color);
      color: #e0e0e0;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
    }
    header a:hover {
      background-color: #5c5c5c;
    }
    /* Mobile Sub-Header - Hidden by default */
    .mobile-sub-header {
      display: none;
      background-color: var(--hdr-color);
      padding: 10px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Mobile Nav Links */
    .mobile-sub-header a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 10px;
      font-size: 18px;
    }

    /* Active State */
    .mobile-sub-header a.active::after {
      content: "";
      display: block;
      height: 2px;
      width: 100%;
      background-color: white;
    }

    /* Hover effect */
    .mobile-sub-header a:hover::after {
      background-color: lightgray;
    }
    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--hdr-color);
        color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        background-size: cover;
        background-position: center;
    }
    .profile-pic.no-picture {
        background-color: #cc4f4f; /* Soft blue background when no picture */
        color: white; /* White text for the initial */
        border-radius: 50%;
    }

     #floating-add-button {
      display: flex;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: var(--btn-color);
      color: #e0e0e0;
      border-radius: 50%;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease;
      z-index: 1000;
    }
    #floating-add-button:hover {
      background-color: #7a7a7a;
    }

    /* Modal Overlay */
    #todo-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    /* Side‑panels: match #todo-modal height & styling */
    #todo-modal {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .side-panel {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 200px;
      background-color: var(--bg-color);
      border: 1px solid var(--hdr-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      z-index: 10;
      overflow-y: auto;
      color: #e0e0e0; /* ensure text visibility */
    }

    .side-panel.left {
      left: 100%;
      transform: translateX(-100%) scaleX(0);
      transform-origin: left center;
    }

    .side-panel.right {
      right: 100%;
      transform: translateX(100%) scaleX(0);
      transform-origin: right center;
    }

    .side-panel.open {
      transform: translateX(0) scaleX(1);
    }


    #todo-modal {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #todo-modal h2 {
      margin-top: 0;
    }
    #todo-modal form {
      display: flex;
      flex-direction: column;
    }
    #todo-modal label {
      margin: 10px 0 5px;
    }
    #todo-modal input,
    #todo-modal textarea {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: var(--btn-color);
    }
    #todo-modal .actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }
    #delete-button {
      background-color: #d9534f !important;
    }
    #delete-button:hover {
      background-color: #c9302c !important;
    }
    #todo-modal button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      background-color: var(--btn-color);
      color: white;
    }
    #todo-modal button.cancel {
      margin-right: 10px;
    }

    /* Toggle Button - hidden by default */
    .toggle-mobile-nav {
    background: none;
    border: none;
    color: #f2f2f2;
    font-size: 24px;
    cursor: pointer;
    display: none; /* Hidden by default */
    margin-right: 10px;
    }
    .toggle-mobile-nav:hover {
      background-color: none;
    }
    /* Desktop Nav - Visible on large screens */
    .desktop-nav {
      display: flex;
      gap: 20px;
    }
    /* Responsive Styles */
    @media (max-width: 600px) {
      .desktop-nav {
        display: none;
      }
      .toggle-mobile-nav {
        display: block;
      }
      header a {
        display: none;
      }
    }
    /* Root variables from your default colors */
    #todo-overview-container {
      background-color: var(--bg-color);
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      margin: 20px auto;
    }
    #todo-overview-container h2 {
      color: white;
      margin-bottom: 16px;
      font-size: 24px;
    }
    .todo-card {
      background-color: var(--btn-color);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .todo-title {
      color: var(--ctr-color);
      font-size: 20px;
      font-weight: 600;
    }
    .todo-text {
      color: #e0e0e0;
      font-size: 16px;
    }
    .todo-due {
      font-size: 14px;
      font-weight: 500;
      align-self: flex-end;
      padding: 4px 8px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
    }
    .todo-due.near {
      background-color: #d9534f; /* matching your palette */
      color: #fff;
    }
    .item-list {
      margin-top: 10px;
      max-height: calc(100% - 50px); /* leave room for header */
      overflow-y: auto;
    }

    .item-card {
      background-color: var(--ctr-color);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .item-card.selected {
      background-color: var(--buttonColor, #555); /* highlight */
    }
    .item-card.selected::after {
      content: "✓";
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 14px;
      color: #4caf50;
      background: transparent;
      border-radius: 0;
      padding: 0;
      z-index: 2;
      pointer-events: none;
      font-weight: bold;
      opacity: 0.85;
      letter-spacing: 0.05em;
    }
    .item-card {
      position: relative; /* Needed for ::after positioning */
    }

    .item-card:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .item-card .tag {
      font-size: 12px;
      font-weight: bold;
      color: #ccc;
      margin-bottom: 4px;
    }

    .item-card .title {
      font-size: 14px;
      font-weight: 600;
    }

    .item-card .snippet {
      font-size: 13px;
      color: #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-list {
      /* Firefox */
      scrollbar-width: none;
      /* IE 10+ */
      -ms-overflow-style: none;
    }

    /* WebKit browsers */
    .item-list::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .side-panel {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }

    .side-panel::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    /* MOBILE LAYOUT: panels above/below under 600px width */
    @media (max-width: 800px) {
      #todo-modal {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        overflow: visible;
        max-height: 90%;
      }
      #todo-modal {
        font-size: x-small;
      }

      .side-panel {
        position: static !important; /* override side position */
        width: 90%;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        border: 1px solid var(--hdr-color);
        border-radius: 8px;
        background: var(--bg-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .side-panel.open {
        max-height: 150px; /* You can tune this */
        opacity: 1;
        overflow-y: auto;
      }

      .side-panel .item-list {
        padding: 8px;
        max-height: 220px;
        overflow-y: auto;
      }

      /* Remove old transforms */
      .side-panel.left,
      .side-panel.right {
        transform: none !important;
      }
    }

    /* Add to your CSS */
    .tag-suggestions {
      position: absolute;
      background: var(--bg-color);
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      width: 300px;
    }

    .tag-suggestion-header {
      padding: 10px 15px;
      font-weight: bold;
      background-color: var(--bg-color);
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
    }

    .tag-suggestion-project {
      padding: 8px 15px;
      font-weight: bold;
      background-color: var(--ctr-color);
      cursor: default;
    }

    .tag-suggestion-branch {
      padding: 10px 15px 10px 25px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tag-suggestion-branch:hover {
      background-color: var(--btn-color);
    }

    .tag-suggestion-branch.selected {
      background-color: var(--btn-color);
    }

    #storage-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:2000; }
    #storage-modal .panel { width: 760px; max-width:96%; background: linear-gradient(90deg,#1b1b1b,#121212); color:white; border-radius:12px; padding:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 3px solid #ffcc00; }
    #storage-modal .header { display:flex; align-items:center; gap:12px; }
    #storage-modal .logo-badge { background:#ffcc00; color:#111; padding:8px 12px; border-radius:8px; font-weight:800; }
    #storage-modal .big { font-size:28px; font-weight:800; }
    #storage-modal .advert { margin-top:12px; background: linear-gradient(90deg,#ff7a18,#af002d); padding:12px; border-radius:8px; text-align:center; font-weight:700; }
    #storage-modal .invites { margin-top:16px; display:flex; gap:12px; }
    #storage-modal .invites .left, #storage-modal .invites .right { flex:1; }
    #storage-modal .input-row { display:flex; gap:8px; margin-top:8px; }
    #storage-modal .btn { padding:10px 14px; border-radius:8px; background:#333; color:white; border:none; cursor:pointer; }
    #storage-modal .btn.primary { background: linear-gradient(90deg,#ffcc00,#ff8a00); color:#111; font-weight:700; }
    #storage-modal .pending-list { max-height:220px; overflow:auto; margin-top:8px; border-top:1px solid rgba(255,255,255,0.06); padding-top:8px; }
    .almost-full { background: linear-gradient(90deg,#e74c3c,#c0392b) !important; }
    .cancel-invite-btn {
        background: transparent;
        position: relative;
        border: 1px solid #ddd;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        left: 300px;
    }

    /* Container for counter + bar */
        #storage-container {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          width: 200px;  /* adjust to your header size */
          font-family: Arial, sans-serif;
          font-size: 12px;
          margin: 0 10px;
      }

      /* Text counter */
      #storage-counter {
          margin-bottom: 4px;
          font-weight: bold;
          color: #ffffff;
      }

      /* Background of progress bar */
      #storage-bar-bg {
          width: 100%;
          height: 8px;
          background-color: #eee;
          border-radius: 4px;
          overflow: hidden;
      }

      /* Filled portion */
      #storage-bar-fill {
          width: 0%; /* dynamically updated by JS */
          height: 100%;
          background: linear-gradient(90deg, #4caf50, #81c784);
          border-radius: 4px 0 0 4px;
          transition: width 0.3s ease, background 0.3s ease;
      }

      /* Red when almost full */
      #storage-bar-fill.almost-full {
          background: linear-gradient(90deg, #ffb74d , #e53935);
      }


  </style>
  <script src="static/admin.js"></script>
  <script src="/static/js/notifications.js"></script>
  <script src="/static/custom-alert.js"></script>

      <style>
        :root {
          --bg-color:  #2c2c2c;  /* defaults */
          --hdr-color: #3a3a3a;
          --ctr-color: #1e1e1e;
          --btn-color: #424242;
        }
      </style>

      <script>
        fetch("/user-colors")
            .then(res => {
                if (!res.ok) throw new Error("Could not load colors");
                return res.json();
            })
            .then(cfg => {
                document.documentElement.style.setProperty("--bg-color",   cfg.background_color);
                document.documentElement.style.setProperty("--hdr-color",  cfg.header_color);
                document.documentElement.style.setProperty("--ctr-color",  cfg.contrasting_color);
                document.documentElement.style.setProperty("--btn-color",  cfg.button_color);

                window.appConfig = {
                    backgroundColor:  cfg.background_color,
                    headerColor:      cfg.header_color,
                    contrastingColor: cfg.contrasting_color,
                    buttonColor:      cfg.button_color
                };
            })
            .catch(err => console.error(err));
        </script>


<header>
    <!-- Toggle button (only visible on mobile) -->
    <button id="toggle-mobile-nav" class="toggle-mobile-nav">☰</button>
    
    <a href="/" class="homepage-link"><h1>Future Notes</h1></a>
    
    <nav class="desktop-nav">
      <a href="/index" class="nav-link">Personal notes</a>
      <a href="/group-notes" class="nav-link">Group notes</a>
      <a href="/scheduler-page" class="nav-link">Calendar</a>
      <a href="/todo_page" class="nav-link active">Todo</a>
    </nav>

    <div id="storage-container" style="margin: 0px 100px;">
        <span id="storage-counter">0 / 0 MB</span>
        <div id="storage-bar-bg">
            <div id="storage-bar-fill"></div>
        </div>
    </div>
    
    <div id="profile-pic" class="profile-pic no-picture"></div>
</header>
  
  <!-- Mobile Sub-Header -->
  <nav id="mobileSubHeader" class="mobile-sub-header">
    <a href="/index" class="nav-link">Personal notes</a>
    <a href="/group-notes" class="nav-link">Group notes</a>
    <a href="/scheduler-page" class="nav-link">Calendar</a>
    <a href="/todo_page" class="nav-link active">Todo</a>
  </nav>  

  <div id="overlay"></div>

  <div id="todo-overview-container">
    <h2>Your Todos</h2>

    <section class="todo-section" id="overdue-section">
      <h3>Overdue</h3>
      <div class="todo-list" id="todo-overdue-list"></div>
    </section>

    <section class="todo-section" id="active-section">
      <h3>Active</h3>
      <div class="todo-list" id="todo-active-list"></div>
    </section>

    <section class="todo-section" id="completed-section">
      <h3>Completed</h3>
      <div class="todo-list" id="todo-completed-list"></div>
    </section>
  </div>


  <div id="floating-add-button">+</div>

  <div id="todo-modal-overlay">
    <div id="todo-modal">
      <h2 id="modal-title">Add Todo</h2>
      
      <!-- New Attach Buttons -->
      <div class="attach-controls">
        <button type="button" id="toggle-appt">Attach Appointment</button>
        <button type="button" id="toggle-note">Attach Note</button>
      </div>

      <!-- Note panel -->
      <div class="side-panel left" id="note-panel">
        <h3>Select Note</h3>
        <!-- hidden input to hold chosen id -->
        <input type="hidden" id="note-id-input" name="note_id">
        <div class="item-list" id="note-list"><!-- populated by JS --></div>
      </div>

      <!-- Appointment Panel -->
      <div class="side-panel right" id="appt-panel">
        <h3>Select Appointment</h3>
        <input type="hidden" id="appt-id-input" name="appointment_id">
        <div class="item-list" id="appt-list"><!-- populated by JS --></div>
      </div>

      <div id="tag-suggestions-dropdown" class="tag-suggestions">
          <div class="tag-suggestion-header">Projects & Branches</div>
          <div id="tag-suggestion-list"></div>
      </div>

      <form id="todo-form">
        <input type="hidden" id="todo-id">
        <label for="todo-title">Title</label>
        <input type="text" id="todo-title" required>

        <label for="todo-due">Due Date</label>
        <input type="datetime-local" id="todo-due">

        <label for="todo-desc">Description</label>
        <textarea id="todo-desc" rows="3"></textarea>

        <div class="actions">
          <button type="button" class="cancel">Cancel</button>
          <button type="submit" id="submit-button">Add</button>
          <button type="button" id="delete-button" style="display: none;">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <div id="storage-modal" role="dialog" aria-hidden="true">
        <div class="panel" role="document">
            <div class="header">
            <div class="logo-badge">FUTURE NOTES</div>
            <div style="flex:1">
                <div class="big">Your storage — make it bigger!</div>
                <div style="opacity:0.8">Store notes, files, memories. Invite friends to grow your quota.</div>
            </div>
            <div><button id="storage-modal-close" class="btn">✕</button></div>
            </div>

            <div class="advert">Invite friends → get <strong>+5MB</strong> per verified signup. Limit: <span id="per-day-limit">3</span>/day. <span style="margin-left:12px">🎉</span></div>

            <div class="invites">
            <div class="left">
                <h4>Current storage</h4>
                <div style="display:flex; align-items:center; gap:12px;">
                <div style="flex:1; background:#222; height:18px; border-radius:12px; padding:3px;">
                    <div id="storage-bar-fill-modal" style="width:0%; height:100%; border-radius:9px; background:linear-gradient(90deg,#ffd166,#ff8a00);"></div>
                </div>
                <div id="storage-counter-modal">0 / 0 MB</div>
                </div>

                <div style="margin-top:12px;">
                <h4>Invite someone</h4>
                <div>Remaining invites today: <strong id="remaining-today">3</strong></div>
                <div class="input-row">
                    <input id="invite-email" type="email" placeholder="friend@example.com" style="flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#0f0f0f; color:white;">
                    <button id="send-invite-btn" class="btn primary">Send Invite</button>
                </div>
                <div id="invite-feedback" style="margin-top:8px; color:#f1c40f;"></div>
                </div>
            </div>

            <div class="right">
                <h4>Pending invites</h4>
                <div class="pending-list" id="pending-invites-list">
                <div style="opacity:0.6">Loading...</div>
                </div>

                <h4 style="margin-top:12px;">Daily stats</h4>
                <div>Sent today: <strong id="sent-today">0</strong></div>
            </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
            // ensure fetch sends cookies
            if (!window.__fetchPatched) {
                const _f = window.fetch;
                window.fetch = (url, opts = {}) => {
                opts.credentials = 'include';
                return _f(url, opts);
                };
                window.__fetchPatched = true;
            }

            // ping a lightweight endpoint to check session
            async function validateSession() {
                try {
                const res = await fetch("/test-session", { method: "GET" });
                if (res.status === 200) {
                    fetchTodos();
                    updateStorageCounter();
                    return true;
                }
                if (res.status === 403) {
                    // banned
                    window.location.href = '/login_page?suspended=true';
                    return false;
                }
                // 401 or anything else → try auto-login
                return false;
                } catch (err) {
                return false;
                }
            }

            // try auto-login via lasting_key cookie on the backend
            async function attemptAutoLogin() {
                try {
                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({})  // backend reads HTTP‐only cookie
                });
                if (res.ok) {
                    console.log("Auto-login successful");
                    fetchTodos();  // re-fetch todos
                    updateStorageCounter();
                    return true;
                }
                // clear any stale lasting_key server‑side—cookie remains but backend will reject next time
                showModal();
                return false;
                } catch (err) {
                showModal();
                return false;
                }
            }
            
        const ok = await validateSession();
        if (!ok) {
            await attemptAutoLogin();
        }
        });

    // Example: update the bar along with the text
        async function updateStorageCounter() {
          try {
              const res = await fetch('/user/storage');
              if (!res.ok) throw new Error("Failed to fetch storage info");
              const data = await res.json();

              const usedMB = (data.used_bytes / 1024 / 1024).toFixed(2);
              const totalMB = (data.total_bytes / 1024 / 1024).toFixed(2);
              const percentUsed = Math.min((data.used_bytes / data.total_bytes) * 100, 100);

              document.getElementById('storage-counter').textContent = `${usedMB} / ${totalMB} MB`;
              document.getElementById('storage-bar-fill').style.width = `${percentUsed}%`;
              if (percentUsed > 90) {
                  document.getElementById('storage-bar-fill').classList.add('almost-full');
              } else {
                  document.getElementById('storage-bar-fill').classList.remove('almost-full');
              }
          } catch (err) {
              console.error(err);
          }
      }

      document.getElementById('storage-container').style.cursor = 'pointer';
      document.getElementById('storage-container').addEventListener('click', openStorageModal);
      document.getElementById('storage-modal-close').addEventListener('click', closeStorageModal);
      document.getElementById('send-invite-btn').addEventListener('click', sendInvite)

      async function openStorageModal(e){
      e && e.preventDefault();
      document.getElementById('storage-modal').style.display = 'flex';
      await refreshModalData();
      }

      function closeStorageModal(){
      document.getElementById('storage-modal').style.display = 'none';
      document.getElementById('invite-feedback').textContent = '';
      }

      async function refreshModalData(){
      try {
          const res = await fetch('/invites/status');
          if (!res.ok) throw new Error('Failed to load status');
          const data = await res.json();

          document.getElementById('storage-counter-modal').textContent = `${data.used_mb} / ${data.total_mb} MB`;
          const percent = Math.min((data.used_mb / Math.max(data.total_mb, 1)) * 100, 100);
          document.getElementById('storage-bar-fill-modal').style.width = percent + '%';
          if (percent > 90) document.getElementById('storage-bar-fill-modal').classList.add('almost-full');
          else document.getElementById('storage-bar-fill-modal').classList.remove('almost-full');

          document.getElementById('remaining-today').textContent = data.remaining_today;
          document.getElementById('sent-today').textContent = data.sent_today;
          document.getElementById('per-day-limit').textContent = data.per_day_limit;

          const pendingList = document.getElementById('pending-invites-list');
          pendingList.innerHTML = '';
          if (!data.pending_invites || data.pending_invites.length === 0) {
          pendingList.innerHTML = '<div style="opacity:0.6">No pending invites</div>';
          } else {
          for (const p of data.pending_invites) {
              const el = document.createElement('div');
              el.style.padding = '8px';
              el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
              el.innerHTML = `<div style="font-weight:700">${p.email}</div><div style="opacity:0.6; font-size:12px">Sent ${new Date(p.created_at).toLocaleString()}</div><button onclick="cancelInvite('${p.id}')" class="cancel-invite-btn">Cancel</button>`;
              pendingList.appendChild(el);
          }
          }
      } catch (err) {
          console.error(err);
          document.getElementById('invite-feedback').textContent = 'Could not load invite status.';
      }
      }

      async function sendInvite(){
      const email = document.getElementById('invite-email').value.trim();
      if (!email) {
          document.getElementById('invite-feedback').textContent = 'Enter an email first.';
          return;
      }
      document.getElementById('send-invite-btn').disabled = true;
      document.getElementById('invite-feedback').textContent = 'Sending...';

      try {
          const res = await fetch('/invites/send', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email})
          });
          const j = await res.json();
          if (!res.ok) {
          document.getElementById('invite-feedback').textContent = j.error || 'Failed to send';
          } else {
          document.getElementById('invite-feedback').textContent = 'Invite sent! They must sign up via the link to redeem.';
          document.getElementById('invite-email').value = '';
          // refresh
          await refreshModalData();
          }
      } catch (err) {
          console.error(err);
          document.getElementById('invite-feedback').textContent = 'Network error';
      } finally {
          document.getElementById('send-invite-btn').disabled = false;
      }
      }

      async function cancelInvite(id) {
          if (!id) return;
          try {
              const res = await fetch(`/invites/cancel/${id}`, { 
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
              });
              const j = await res.json();
              if (!res.ok) {
                  document.getElementById('invite-feedback').textContent = j.error || 'Failed to cancel invite';
              } else {
                  document.getElementById('invite-feedback').textContent = 'Invite canceled.';
                  await refreshModalData();
              }
          } catch (err) {
              console.error(err);
              document.getElementById('invite-feedback').textContent = 'Network error';
          }
      }

    let tagSuggestions = [];
    let currentInputElement = null;

    // Fetch tag suggestions when modal opens
    async function fetchTagSuggestions() {
      try {
        const res = await fetch('/flow/tag-suggestions', {
          headers: { }
        });
        if (res.ok) {
          tagSuggestions = await res.json();
        }
      } catch (err) {
        console.error('Error fetching tag suggestions', err);
      }
    }

    // Element refs
    const addBtn        = document.getElementById('floating-add-button');
    const overlay       = document.getElementById('todo-modal-overlay');
    const modalTitle    = document.getElementById('modal-title');
    const form          = document.getElementById('todo-form');
    const submitBtn     = document.getElementById('submit-button');
    const cancelBtn     = document.querySelector('#todo-modal .cancel');
    const deleteBtn     = document.getElementById('delete-button');

    const toggleNoteBtn = document.getElementById('toggle-note');
    const toggleApptBtn = document.getElementById('toggle-appt');
    const notePanel     = document.getElementById('note-panel');
    const apptPanel     = document.getElementById('appt-panel');

    const noteListEl    = document.getElementById('note-list');
    const apptListEl    = document.getElementById('appt-list');
    const noteIdInput   = document.getElementById('note-id-input');
    const apptIdInput   = document.getElementById('appt-id-input');

    // State
    let notesList = [];
    let apptsList = [];

    async function openModal(mode, data = {}) {
      overlay.style.display     = 'flex';
      modalTitle.textContent    = mode === 'add' ? 'Add Todo' : 'Edit Todo';
      submitBtn.textContent     = mode === 'add' ? 'Add' : 'Save';

      // Show pro-tip label only once using localStorage
      const proTipKey = "todo_protip_shown";
      let proTipLabel = document.getElementById("pro-tip-label");
      if (!localStorage.getItem(proTipKey)) {
        if (!proTipLabel) {
          proTipLabel = document.createElement("div");
          proTipLabel.id = "pro-tip-label";
          proTipLabel.textContent = "Pro tip: Ctrl+click on an appointment or note in the panel opens a new tab to view your notes or appointments!";
          proTipLabel.style.position = "absolute";
          proTipLabel.style.left = "50%";
          proTipLabel.style.transform = "translateX(-50%)";
          proTipLabel.style.top = "60px";
          proTipLabel.style.background = "linear-gradient(90deg, #333 0%, #444 100%)";
          proTipLabel.style.color = "#fff";
          proTipLabel.style.padding = "10px 18px";
          proTipLabel.style.borderRadius = "8px";
          proTipLabel.style.boxShadow = "0 2px 8px rgba(0,0,0,0.18)";
          proTipLabel.style.fontSize = "14px";
          proTipLabel.style.zIndex = "1002";
          proTipLabel.style.whiteSpace = "normal";
          proTipLabel.style.maxWidth = "320px";
          proTipLabel.style.textAlign = "center";
          proTipLabel.style.pointerEvents = "auto";
          proTipLabel.style.userSelect = "none";
          proTipLabel.style.fontWeight = "500";
          proTipLabel.style.lineHeight = "1.4";
          proTipLabel.style.transition = "opacity 0.3s";
          proTipLabel.style.opacity = "1";
          proTipLabel.style.marginTop = "8px";
          proTipLabel.innerHTML += `<span style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:12px solid #333;z-index:1003;"></span>`;
          // Insert after the attach-controls div
          const attachControls = document.querySelector(".attach-controls");
          attachControls.style.position = "relative";
          attachControls.appendChild(proTipLabel);
          proTipLabel.addEventListener("click", () => {
            proTipLabel.style.opacity = "0";
            setTimeout(() => proTipLabel.remove(), 400);
          });
        }
        localStorage.setItem(proTipKey, "1");
      }

      await fetchTagSuggestions();

      setupTagDetection();

      // Prefill core fields
      document.getElementById('todo-id').value   = data.id || '';
      document.getElementById('todo-title').value= data.title || '';
      document.getElementById('todo-due').value  = data.due ? data.due.substring(0,16) : '';
      document.getElementById('todo-desc').value = data.description || '';

      // Reset panels & inputs
      notePanel.classList.remove('open');
      apptPanel.classList.remove('open');
      noteIdInput.value = data.note_id || '';
      apptIdInput.value = data.appointment_id || '';

      // Toggle delete button only in edit mode
      if (mode === 'edit') {
        deleteBtn.style.display = 'inline-block';
        // store the current id on the button so we can use it in the handler:
        deleteBtn.dataset.id = data.id;
      } else {
        deleteBtn.style.display = 'none';
        deleteBtn.dataset.id = '';
      }

      // Fetch attachments
      try {
        const [notesRes, apptsRes] = await Promise.all([
          fetch('/notes_fetch', {
            headers: {  }
          }),
          fetch('/appointments_fetch', {
            headers: {  }
          })
        ]);
        if (notesRes.ok && apptsRes.ok) {
          notesList = (await notesRes.json()).notes;
          apptsList = (await apptsRes.json()).appointments;
          populateList(noteListEl, notesList, 'note');
          populateList(apptListEl, apptsList, 'appt');
        }
      } catch (err) {
        console.error('Error fetching attachments', err);
      }

      // After populateList(...) and before submit handler:

      // Auto‑select existing attachments sequentially
      async function selectAttachment(panel, listEl, inputEl, id) {
        if (!id) return;
        panel.classList.add('open');
        // Wait for panel transition (300ms)
        await new Promise(resolve => setTimeout(resolve, 500));
        const card = listEl.querySelector(`.item-card[data-id="${id}"]`);
        if (card) {
          card.classList.add('selected');
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        inputEl.value = id;
      }

      (async () => {
        if (data.note_id) {
          await selectAttachment(notePanel, noteListEl, noteIdInput, data.note_id);
        }
        if (data.appointment_id) {
          await selectAttachment(apptPanel, apptListEl, apptIdInput, data.appointment_id);
        }
      })();


      // Submit handler
      form.onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
          title:          document.getElementById('todo-title').value,
          due_date:       document.getElementById('todo-due').value,
          description:    document.getElementById('todo-desc').value,
          note_id:        noteIdInput.value || null,
          appointment_id: apptIdInput.value || null
        };
        let url = '/todos';
        let method = 'POST';
        if (mode === 'edit') {
          url = `/todos/${data.id}`;
          method = 'PUT';
        }
        try {
          const res = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              
            },
            body: JSON.stringify(payload)
          });
          if (res.ok) location.reload();
          else console.error('Error saving todo');
        } catch (err) {
          console.error('Network error', err);
        }
      };
    }

    function setupTagDetection() {
      const titleInput = document.getElementById('todo-title');
      const descInput = document.getElementById('todo-desc');
      
      [titleInput, descInput].forEach(input => {
        input.addEventListener('input', handleTagInput);
        input.addEventListener('keydown', handleTagKeydown);
        input.addEventListener('click', handleTagClick);
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('tag-suggestions-dropdown');
        if (!dropdown.contains(e.target) && !titleInput.contains(e.target) && !descInput.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
    }

    function handleTagInput(e) {
      const input = e.target;
      const value = input.value;
      const cursorPos = input.selectionStart;
      
      // Check if we're typing a hashtag
      if (value[cursorPos - 1] === '#' || 
          (value.substring(cursorPos - 1, cursorPos) === '#')) {
        showTagSuggestions(input, cursorPos);
      } else {
        document.getElementById('tag-suggestions-dropdown').style.display = 'none';
      }
    }

    function handleTagClick(e) {
      const input = e.target;
      const cursorPos = input.selectionStart;
      showTagSuggestions(input, cursorPos);
    }

    function handleTagKeydown(e) {
      const dropdown = document.getElementById('tag-suggestions-dropdown');
      if (dropdown.style.display !== 'block') return;
      
      const items = dropdown.querySelectorAll('.tag-suggestion-branch');
      if (!items.length) return;
      
      const currentSelected = dropdown.querySelector('.tag-suggestion-branch.selected');
      let currentIndex = currentSelected ? Array.from(items).indexOf(currentSelected) : -1;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const newIndex = (currentIndex + 1) % items.length;
        selectSuggestionItem(items, newIndex);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const newIndex = (currentIndex - 1 + items.length) % items.length;
        selectSuggestionItem(items, newIndex);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentSelected) {
          insertTag(currentSelected);
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
      }
    }

    function showTagSuggestions(input, cursorPos) {
      currentInputElement = input;
      const dropdown = document.getElementById('tag-suggestions-dropdown');
      const rect = input.getBoundingClientRect();
      
      // Position dropdown below cursor
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.display = 'block';
      
      // Populate suggestions
      populateTagSuggestions();
    }

    function populateTagSuggestions() {
      const container = document.getElementById('tag-suggestion-list');
      container.innerHTML = '';
      
      if (!tagSuggestions.length) {
        container.innerHTML = '<div class="tag-suggestion-branch">No projects found</div>';
        return;
      }
      
      tagSuggestions.forEach(project => {
        // Add project header (non-selectable)
        const projectHeader = document.createElement('div');
        projectHeader.className = 'tag-suggestion-project';
        projectHeader.textContent = project.title;
        container.appendChild(projectHeader);
        
        // Add branches
        project.branches.forEach(branch => {
          const branchItem = document.createElement('div');
          branchItem.className = 'tag-suggestion-branch';
          branchItem.dataset.projectId = project.id;
          branchItem.dataset.projectTitle = project.title;
          branchItem.dataset.branchId = branch.id;
          branchItem.dataset.branchName = branch.name;
          
          branchItem.innerHTML = `
            <span>${branch.name}</span>
            ${branch.is_main ? '<span class="tag-main-indicator">(main)</span>' : ''}
          `;
          
          branchItem.addEventListener('click', () => insertTag(branchItem));
          container.appendChild(branchItem);
        });
      });
    }

    function selectSuggestionItem(items, index) {
      items.forEach(item => item.classList.remove('selected'));
      items[index].classList.add('selected');
      items[index].scrollIntoView({ block: 'nearest' });
    }

    function insertTag(branchElement) {
      if (!currentInputElement) return;
      
      const projectId = branchElement.dataset.projectId;
      const branchName = branchElement.dataset.branchName;
      
      // Create tags
      const projectTag = `#proj-${projectId}`;
      const branchTag = `#branch-${branchName.replace(/\s+/g, '-')}`;
      
      // Insert tags at cursor position
      const cursorPos = currentInputElement.selectionStart;
      const value = currentInputElement.value;
      
      // Check if we're replacing a partial tag
      let newValue, newCursorPos;
      
      if (value.substring(cursorPos - 1, cursorPos) === '#') {
        // Insert after the #
        newValue = value.substring(0, cursorPos) + 
                  `${projectTag} ${branchTag} ` + 
                  value.substring(cursorPos);
        newCursorPos = cursorPos + projectTag.length + branchTag.length + 3;
      } else {
        // Find the start of the current word
        let start = cursorPos - 1;
        while (start >= 0 && !/\s/.test(value[start])) {
          start--;
        }
        start = Math.max(start + 1, 0);
        
        newValue = value.substring(0, start) + 
                  `${projectTag} ${branchTag} ` + 
                  value.substring(cursorPos);
        newCursorPos = start + projectTag.length + branchTag.length + 3;
      }
      
      currentInputElement.value = newValue;
      currentInputElement.focus();
      currentInputElement.setSelectionRange(newCursorPos, newCursorPos);
      
      // Close dropdown
      document.getElementById('tag-suggestions-dropdown').style.display = 'none';
    }

    // Toggle handlers
    toggleNoteBtn.onclick = () => {
      notePanel.classList.toggle('open');
    };

    toggleApptBtn.onclick = () => {
      apptPanel.classList.toggle('open');
    };

    cancelBtn.onclick = closeModal;


    // Utility: truncate text to N words
    function firstWords(text, n=5) {
      return text.split(/\s+/).slice(0, n).join(' ') + (text.split(/\s+/).length > n ? '…' : '');
    }

    // Populate a list of cards
    function populateList(containerEl, items, type) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
      // Show message and button if empty
      const msg = document.createElement('div');
      msg.style.textAlign = 'center';
      msg.style.padding = '20px 0';
      msg.style.color = '#bbb';
      msg.textContent = `You don't have any ${type === 'note' ? 'notes' : 'appointments'} yet!`;

      const btn = document.createElement('button');
      btn.textContent = `Create your first ${type === 'note' ? 'note' : 'appointment'}!`;
      btn.style.marginTop = '12px';
      btn.style.padding = '8px 18px';
      btn.style.borderRadius = '6px';
      btn.style.border = 'none';
      btn.style.background = 'var(--btn-color)';
      btn.style.color = '#fff';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        window.location.href = type === 'note' ? '/index' : '/scheduler-page';
      };

      containerEl.appendChild(msg);
      containerEl.appendChild(btn);
      return;
      }
      items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'item-card';
      card.dataset.id = item.id;

      // build inner HTML (same as before)…
      if (type === 'note') {
        const tag   = item.tag ? `<div class="tag">${item.tag}</div>` : '';
        const title = item.title
        ? `<div class="title">${item.title}</div>`
        : `<div class="title">${firstWords(item.note)}</div>`;
        const snippet = `<div class="snippet">${firstWords(item.note, 10)}</div>`;
        card.innerHTML = tag + title + snippet;
      } else {
        const title   = `<div class="title">${item.title}</div>`;
        const endDt   = new Date(item.end_datetime).toLocaleString();
        const snippet = `<div class="snippet">Ends: ${endDt}</div>`;
        card.innerHTML = title + snippet;
      }

      card.addEventListener('click', (e) => {
        // Ctrl+click: open /index or /scheduler-page
        if (e.ctrlKey || e.metaKey) {
        window.open(type === 'note' ? '/index' : '/scheduler-page', '_blank');
        return;
        }
        const alreadySelected = card.classList.contains('selected');

        // Clear all selections
        Array.from(containerEl.children).forEach(c => c.classList.remove('selected'));

        if (!alreadySelected) {
        // Select this one
        card.classList.add('selected');
        if (type === 'note')     noteIdInput.value = item.id;
        else                      apptIdInput.value = item.id;
        } else {
        // Deselected
        if (type === 'note')     noteIdInput.value = '';
        else                      apptIdInput.value = '';
        }
      });

      containerEl.appendChild(card);
      });
    }


    function closeModal() {
      overlay.style.display = 'none';
    }

    // Event: Add button click
    addBtn.addEventListener('click', () => openModal('add'));
    cancelBtn.addEventListener('click', closeModal);

    deleteBtn.addEventListener('click', async () => {
      const todoId = deleteBtn.dataset.id;
      if (!todoId) return;

      try {
        const res = await fetch(`/todos/${todoId}`, {
          method: 'DELETE',
          headers: {
            
          }
        });
        if (res.ok) {
          closeModal();
          // you can either reload the page:
          // location.reload();
          // or re-fetch and re-render just the list:
          fetchTodos();
        } else {
          console.error('Error deleting todo');
        }
      } catch (err) {
        console.error('Network error deleting todo', err);
      }
    });


    // Event: Clicking a todo item (delegated to the overview container)
    document.getElementById('todo-overview-container')
      .addEventListener('click', e => {
        const card = e.target.closest('.todo-card');
        if (!card) return;

        openModal('edit', {
          id:             card.dataset.id,
          title:          card.dataset.title,
          due:            card.dataset.due,
          description:    card.dataset.text,       // use data-text
          note_id:        card.dataset.noteId   || '',
          appointment_id: card.dataset.apptId   || ''
        });
      });



    function showModal() {
      window.location.href = "/login_page?redirect=/todo_page&warning=true";
    }
    function hideModal() {
      // No action needed; placeholder function
    }
    document.addEventListener("DOMContentLoaded", function() {
      const toggleButton = document.getElementById("toggle-mobile-nav");
      const mobileNav = document.getElementById("mobileSubHeader");

      toggleButton.addEventListener("click", function() {
        // Toggle between showing and hiding the mobile nav
        if (mobileNav.style.display === "block") {
          mobileNav.style.display = "none";
        } else {
          mobileNav.style.display = "block";
        }
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const cfg = window.appConfig || {};

        // store in a JS var if you need it elsewhere
        const userColors = {
            bg:  cfg.backgroundColor,
            hdr: cfg.headerColor,
            ctr: cfg.contrastingColor,
            btn: cfg.buttonColor
        };

        // apply each to the CSS custom properties
        const root = document.documentElement;
        root.style.setProperty("--bg-color",  userColors.bg);
        root.style.setProperty("--hdr-color", userColors.hdr);
        root.style.setProperty("--ctr-color", userColors.ctr);
        root.style.setProperty("--btn-color", userColors.btn);

        // now your CSS (using var(--bg-color), etc.) will reflect the user’s choices
        });
    window.onload = async () => {
      try {
        const response = await fetch("/test-session", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            
          },
        });
        if (response.status === 401) {
          showModal();
        } else {
          const userInfoResponse = await fetch("/user-info", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              
            },
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            const username = userInfo.username;
            const profilePic = userInfo.profile_picture;
            const profilePicElement = document.getElementById("profile-pic");
            if (profilePic) {
              const correctedProfilePic = profilePic.replace(/\\/g, "/");
              profilePicElement.style.backgroundImage = `url(${correctedProfilePic})`;
              profilePicElement.classList.remove("no-picture");
              profilePicElement.textContent = "";
            } else {
              profilePicElement.textContent = username[0].toUpperCase();
              profilePicElement.classList.add("no-picture");
            }
          } else {
            console.error("Failed to fetch user info");
          }
        }
      } catch (error) {
        console.error("Error during re-login:", error);
      }
    };
    document.getElementById("profile-pic").addEventListener("click", showAccountMenu);
    function showAccountMenu() {
      window.location.href = "/account_page";
    }
    sessionStorage.setItem("last_page", "/todo_page");

    // Fetch and render todos into Overdue, Active, and Completed lists
    async function fetchTodos() {
      
      const now = new Date();

      // List containers
      const overdueList   = document.getElementById('todo-overdue-list');
      const activeList    = document.getElementById('todo-active-list');
      const completedList = document.getElementById('todo-completed-list');

      // Clear existing
      [overdueList, activeList, completedList].forEach(el => el.innerHTML = '');

      try {
        const res  = await fetch('/todos', {
        });
        const data = await res.json();
        const todos = Array.isArray(data.todos) ? data.todos : [];

        if (todos.length === 0) {
          // No todos at all → placeholder in Active
          activeList.appendChild(createEmptyMsg('You have no todos yet. Click here to add one!'));
          return;
        }

        todos.forEach(todo => {
          const dueDate    = todo.due_date ? new Date(todo.due_date) : null;
          const isOverdue  = !todo.completed && dueDate && dueDate < now;
          const isActive   = !todo.completed && (!dueDate || dueDate >= now);
          const isComplete = !!todo.completed;

          const card = createTodoCard(todo, now);

          if (isOverdue)     overdueList.appendChild(card);
          else if (isActive)    activeList.appendChild(card);
          else if (isComplete) completedList.appendChild(card);
        });

        // Add empty‑state placeholders if needed
        [
          { list: overdueList,   text: 'No overdue todos!'       },
          { list: activeList,    text: 'No active todos! 😌'     },
          { list: completedList, text: 'No completed todos yet.' }
        ].forEach(({ list, text }) => {
          if (list.children.length === 0) {
            list.appendChild(createEmptyMsg(text));
          }
        });

      } catch (err) {
        console.error('Error fetching todos:', err);
        activeList.textContent = 'Failed to load todos.';
      }
    }

    // Helper: “empty” placeholder
    function createEmptyMsg(text) {
      const div = document.createElement('div');
      div.textContent     = text;
      div.style.cursor    = 'pointer';
      div.style.textAlign = 'center';
      div.style.padding   = '24px 0';
      div.style.color     = '#bbb';
      div.addEventListener('click', () => openModal('add'));
      return div;
    }

    // Build a single todo card element
    function createTodoCard(todo, now) {
      const dueDate = todo.due_date ? new Date(todo.due_date) : null;

      // Card container
      const card = document.createElement('div');
      card.className = 'todo-card';
      card.dataset.id          = todo.id;
      card.dataset.title       = todo.title;
      card.dataset.due         = todo.due_date || '';
      card.dataset.text        = todo.text    || '';    // <— ensure data-text for prefill!
      card.dataset.description = todo.text    || '';
      if (todo.note_id)        card.dataset.noteId = todo.note_id;
      if (todo.appointment_id) card.dataset.apptId = todo.appointment_id;

      // Checkbox wrapper
      const checkboxWrapper = document.createElement('label');
      checkboxWrapper.style.display       = "flex";
      checkboxWrapper.style.alignItems    = "center";
      checkboxWrapper.style.gap           = "8px";
      checkboxWrapper.style.cursor        = "pointer";
      checkboxWrapper.style.marginBottom  = "8px";
      checkboxWrapper.style.position      = "relative";
      checkboxWrapper.style.width         = "50px";
      checkboxWrapper.style.maxWidth      = "50px";
      checkboxWrapper.style.minWidth      = "24px";
      checkboxWrapper.style.flex          = "0 0 24px";
      checkboxWrapper.style.justifyContent= "flex-start";

      // Native checkbox (hidden)
      const checkbox = document.createElement('input');
      checkbox.type    = 'checkbox';
      checkbox.checked = !!todo.completed;
      checkbox.style.width       = "20px";
      checkbox.style.height      = "20px";
      checkbox.style.accentColor = "#4caf50";
      checkbox.title  = checkbox.checked
        ? "Mark as not completed"
        : "Mark as completed";
      checkbox.style.opacity   = "0";
      checkbox.style.position  = "absolute";

      // Custom checkmark
      const customCheck = document.createElement('span');
      customCheck.style.display       = "inline-block";
      customCheck.style.width         = "20px";
      customCheck.style.height        = "20px";
      customCheck.style.border        = "2px solid #bbb";
      customCheck.style.borderRadius  = "5px";
      customCheck.style.background    = checkbox.checked ? "#4caf50" : "transparent";
      customCheck.style.position      = "relative";
      customCheck.style.transition    = "background 0.2s";
      customCheck.style.marginRight   = "4px";
      customCheck.style.pointerEvents = "none";
      if (checkbox.checked) {
        customCheck.innerHTML = `
          <svg width="16" height="16" style="position:absolute;top:2px;left:2px;" viewBox="0 0 16 16">
        <polyline points="3,8 7,12 13,4"
          style="fill:none;stroke:white;stroke-width:2"/>
          </svg>`;
      }

      // Prevent clicks on checkbox from bubbling to card
      checkbox.addEventListener('click', e => {
        e.stopPropagation();
        e.stopImmediatePropagation();
      });
      checkboxWrapper.addEventListener('click', e => {
        e.stopPropagation();
      });

      // Toggle completed state
      checkbox.addEventListener('change', async e => {
        e.stopPropagation();
        checkbox.disabled = true;
        try {
          await toggleTodoCompleted(todo.id);
          await fetchTodos();
        } catch (err) {
          console.error('Failed to toggle todo completed', err);
        }
        checkbox.disabled = false;
      });

      // Sync custom checkmark on input
      checkbox.addEventListener('input', () => {
        if (checkbox.checked) {
          customCheck.style.background = "#4caf50";
          customCheck.innerHTML = `
            <svg width="16" height="16" style="position:absolute;top:2px;left:2px;" viewBox="0 0 16 16">
              <polyline points="3,8 7,12 13,4"
                style="fill:none;stroke:white;stroke-width:2"/>
            </svg>`;
        } else {
          customCheck.style.background = "transparent";
          customCheck.innerHTML = "";
        }
      });

      checkboxWrapper.appendChild(checkbox);
      checkboxWrapper.appendChild(customCheck);

      // Title and text
      const title = document.createElement('div');
      title.className   = 'todo-title';
      title.textContent = todo.title;

      const text = document.createElement('div');
      text.className    = 'todo-text';
      text.textContent  = todo.text || '';

      // Due date display
      if (dueDate) {
        const dueEl = document.createElement('div');
        dueEl.className = 'todo-due';
        dueEl.textContent = `Due: ${dueDate.toLocaleString()}`;
        const diffMs = dueDate - now;
        const diffDays = diffMs / (1000 * 60 * 60 * 24);

        let statusText = '';
        if (todo.completed) {
          statusText = 'On time!';
        } else if (dueDate < now) {
          statusText = 'Overdue!';
        } else if (diffDays <= 1) {
          dueEl.classList.add('near');
          statusText = 'Almost due!';
        } else {
          statusText = 'Plenty of time left :)';
        }

        // Add status text
        const statusEl = document.createElement('span');
        statusEl.style.marginLeft = '10px';
        statusEl.style.fontWeight = 'bold';
        statusEl.style.fontSize = '13px';
        statusEl.textContent = statusText;
        dueEl.appendChild(statusEl);

        card.appendChild(dueEl);
      }

      // Highlight overdue
      if (!todo.completed && dueDate && dueDate < now) {
        // Red gradient for overdue (similar to completed's green)
        card.style.background = "linear-gradient(90deg, #e5393540 0%, #e5393515 100%)";
        card.style.borderLeft = '4px solid #e53935';
      }

      // Style completed
      if (todo.completed) {
        card.style.background = "linear-gradient(90deg, #4caf5040 0%, #4caf5015 100%)";
        card.style.opacity    = "0.85";
      }

      // Assemble card
      card.appendChild(checkboxWrapper);
      card.appendChild(title);
      card.appendChild(text);

      // Open edit modal on card click (unless click was on checkbox)
      card.addEventListener('click', e => {
        if (e.target.closest('input[type="checkbox"]')) return;
        openModal('edit', card.dataset.id);
      });

      return card;
    }

    // Toggle completed state on server
    async function toggleTodoCompleted(todoId) {
      
      const res = await fetch(`/todos/${todoId}/toggle-completed`, {
        method: "POST",
      });
      if (!res.ok) throw new Error("Failed to toggle todo completed");
      return res.json();
    }

    function startAutoRefreshTodos() {
      setInterval(fetchTodos, 1000000); // 1 minute; because were calling fetchTodos and not reloading the page, modals will not be closed
    }
    startAutoRefreshTodos();

    // Expose fetchTodos globally
    window.fetchTodos = fetchTodos;
</script>