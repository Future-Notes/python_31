<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Future Notes â€” Trello</title>
    <script src="/static/js/loader.js"></script>
    <script src="/static/custom-alert.js"></script>
    <script src="/static/admin.js"></script>
    <script src="/static/js/notifications.js"></script>
    <style>
        :root {
            --bg-color:  #2c2c2c;
            --hdr-color: #3a3a3a;
            --ctr-color: #1e1e1e;
            --btn-color: #424242;
        }
    </style>

    <script>
        fetch("/user-colors")
            .then(res => {
                if (!res.ok) throw new Error("Could not load colors");
                return res.json();
            })
            .then(cfg => {
                document.documentElement.style.setProperty("--bg-color", cfg.background_color);
                document.documentElement.style.setProperty("--hdr-color", cfg.header_color);
                document.documentElement.style.setProperty("--ctr-color", cfg.contrasting_color);
                document.documentElement.style.setProperty("--btn-color", cfg.button_color);

                window.appConfig = {
                    backgroundColor: cfg.background_color,
                    headerColor: cfg.header_color,
                    contrastingColor: cfg.contrasting_color,
                    buttonColor: cfg.button_color
                };
            })
            .catch(err => console.error(err));
    </script>

    <style>
        :root {
        --bg-color:  #2c2c2c;
        --ctr-color: #1e1e1e;
        --btn-color: #424242;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
        }

        header {
            background-color: var(--hdr-color);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: #f2f2f2;
        }

        nav {
            display: flex;
            gap: 20px;
        }

        nav a {
            text-decoration: none;
        }

        .nav-link {
            position: relative;
            color: white;
            font-size: 18px;
            padding: 5px 0;
            transition: all 0.3s ease;
        }

        .nav-link::after {
            content: "";
            display: block;
            height: 2px;
            width: 0;
            background-color: transparent;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
            background-color: lightgray;
        }

        .nav-link.active::after {
            width: 100%;
            background-color: white;
        }

        .homepage-link {
            text-decoration: none;
            background-color: var(--ctr-color);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
        }

        header a:hover {
            background-color: #5c5c5c;
        }

        .mobile-sub-header {
            display: none;
            background-color: var(--bg-color);
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: relative;
        }

        .mobile-sub-header a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px;
            font-size: 18px;
        }

        .mobile-sub-header a.active::after {
            content: "";
            display: block;
            height: 2px;
            width: 100%;
            background-color: white;
        }

        .mobile-sub-header a:hover::after {
            background-color: lightgray;
        }

        .desktop-nav {
            display: flex;
            gap: 20px;
            margin: 0 auto;
        }

        .toggle-mobile-nav {
            background: none;
            border: none;
            color: #f2f2f2;
            font-size: 24px;
            cursor: pointer;
            display: none;
            margin-right: 10px;
        }

        .mobile-header {
            display: none;
            align-items: center;
        }

        @media (max-width: 600px) {
            .desktop-nav {
                display: none;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .toggle-mobile-nav {
                display: block;
            }
            
            .homepage-link {
                display: none;
            }
            #storage-container {
                margin: 0 0 !important;
                margin-right: 166px !important;
            }
        }

        /* Container for counter + bar */
        #storage-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 200px;  /* adjust to your header size */
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 0 10px;
        }

        /* Text counter */
        #storage-counter {
            margin-bottom: 4px;
            font-weight: bold;
            color: #ffffff;
        }

        /* Background of progress bar */
        #storage-bar-bg {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        /* Filled portion */
        #storage-bar-fill {
            width: 0%; /* dynamically updated by JS */
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px 0 0 4px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        /* Red when almost full */
        #storage-bar-fill.almost-full {
            background: linear-gradient(90deg, #ffb74d , #e53935);
        }

        #storage-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:2000; }
        #storage-modal .panel { width: 760px; max-width:96%; background: linear-gradient(90deg,#1b1b1b,#121212); color:white; border-radius:12px; padding:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 3px solid #ffcc00; }
        #storage-modal .header { display:flex; align-items:center; gap:12px; }
        #storage-modal .logo-badge { background:#ffcc00; color:#111; padding:8px 12px; border-radius:8px; font-weight:800; }
        #storage-modal .big { font-size:28px; font-weight:800; }
        #storage-modal .advert { margin-top:12px; background: linear-gradient(90deg,#ff7a18,#af002d); padding:12px; border-radius:8px; text-align:center; font-weight:700; }
        #storage-modal .invites { margin-top:16px; display:flex; gap:12px; }
        #storage-modal .invites .left, #storage-modal .invites .right { flex:1; }
        #storage-modal .input-row { display:flex; gap:8px; margin-top:8px; }
        #storage-modal .btn { padding:10px 14px; border-radius:8px; background:#333; color:white; border:none; cursor:pointer; }
        #storage-modal .btn.primary { background: linear-gradient(90deg,#ffcc00,#ff8a00); color:#111; font-weight:700; }
        #storage-modal .pending-list { max-height:220px; overflow:auto; margin-top:8px; border-top:1px solid rgba(255,255,255,0.06); padding-top:8px; }
        .almost-full { background: linear-gradient(90deg,#e74c3c,#c0392b) !important; }
        
        /* Infinite storage rainbow bar */
        .infinite-storage {
            background-image: linear-gradient(
                270deg,
                #ff0000,
                #ff7f00,
                #ffff00,
                #00ff00,
                #0000ff,
                #4b0082,
                #8f00ff
            ) !important;
            background-size: 1400% 1400% !important;
            background-position: 0% 50% !important;
            animation: rainbowSlide 5s linear infinite !important;
        }

        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50% !important;
            }
            50% {
                background-position: 100% 50% !important;
            }
            100% {
                background-position: 0% 50% !important;
            }
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #modal {
            background-color: var(--ctr-color);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
        }

        #username, #password {
            width: calc(100% - 24px);
            margin: 10px 0;
            background-color: var(--btn-color);
            border: 1px solid #424242;
            color: #E0E0E0;
            padding: 10px;
            border-radius: 8px;
        }

        input {
            background-color: var(--btn-color);
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            outline: none;
            transition: background-color 0.2s;
        }

        button {
            background-color: var(--btn-color);
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input:focus {
            background-color: #5a5a5a;
        }

        button:hover {
            background-color: #616161;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--hdr-color);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }
        
        .profile-pic.no-picture {
            background-color: #cc4f4f;
            color: white;
            border-radius: 50%;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            animation: fadeIn 0.2s forwards 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <style>
        .app-wrap { display:flex; height:calc(100vh - 64px); } /* viewport minus header */
    /* Sidebar */
    .sidebar { width: 240px; background: linear-gradient(180deg,var(--ctr-color), #111); padding:12px; box-shadow: 2px 0 8px rgba(0,0,0,0.6); overflow:auto; }
    .sidebar h3 { margin:0 0 8px 0; font-size:14px; color:#fff; }
    .boards-list { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .board-item { padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .board-item.active { background: rgba(255,255,255,0.04); font-weight:700; }
    .board-actions { display:flex; gap:6px; }
    .small-btn { background:var(--btn-color); border:none; padding:6px 8px; border-radius:6px; cursor:pointer; color:#e0e0e0; font-size:13px; }
    /* Main area */
    .main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    .board-header { background: transparent; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:space-between; }
    .board-title { font-size:18px; font-weight:800; }
    .lists-wrap { padding:12px; display:flex; gap:16px; overflow-x:auto; align-items:flex-start; height:100%; }
    .list { min-width:280px; max-width:320px; background: linear-gradient(180deg,var(--ctr-color), #131313); padding:12px; border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display:flex; flex-direction:column; gap:8px; }
    .list h4 { margin:0; font-size:14px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .card-list { min-height:40px; display:flex; flex-direction:column; gap:8px; }
    .card { background:#101010; padding:8px 10px; border-radius:8px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); cursor:grab; user-select:none; display:flex; justify-content:space-between; }
    .card .meta { font-size:12px; opacity:0.7; }
    .floating-add {
        display: flex;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: var(--btn-color);
        color: #e0e0e0;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
        font-size: 30px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s ease;
        z-index: 1000;
    }

    .floating-add:hover {
        background-color: #7a7a7a;
    }
    /* modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:2000; }
    .modal { background:#121212; padding:18px; border-radius:12px; width:420px; max-width:96%; box-shadow:0 10px 40px rgba(0,0,0,0.6); border:2px solid var(--accent); }
    .modal h3 { margin:0 0 10px 0; }
    .modal .row { display:flex; gap:8px; margin-top:10px; }
    .modal input { flex:1; padding:10px; border-radius:8px; border:1px solid #333; background: #0f0f0f; color:white; }
    .modal .actions { margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }
    /* responsive adjustments */
    @media (max-width: 900px) {
        .sidebar { display:none; }
        .main { padding-left:12px; }
    }

    /* START PAGE */
    .start-page { padding: 24px; display:flex; flex-direction:column; gap:18px; }
    .start-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px; }
    .board-card { background: linear-gradient(180deg, #161616, #0f0f0f); padding:16px; border-radius:12px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); cursor:pointer; display:flex; flex-direction:column; gap:8px; }
    .board-card h3 { margin:0; font-size:16px; }
    .board-card p { margin:0; opacity:0.7; font-size:13px; }
    .empty-card { display:flex; align-items:center; justify-content:center; height:140px; font-size:18px; font-weight:700; border: 2px dashed rgba(255,255,255,0.06); }

    .create-large { display:flex; align-items:center; justify-content:center; gap:12px; height:140px; font-size:22px; font-weight:800; border-radius:12px; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }

    </style>
    <!-- SortableJS CDN (drag & drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
<header>
    <div class="mobile-header">
        <button id="toggle-mobile-nav" class="toggle-mobile-nav">â˜°</button>
        <input type="password" style="position: absolute; left: -9999px; opacity: 0;">
    </div>
    
    <a href="/" class="homepage-link"><h1>Future Notes</h1></a>
    <nav class="desktop-nav">
        <a href="/index" class="nav-link">Notes</a>
        <a href="/scheduler-page" class="nav-link">Calendar</a>
        <a href="/todo_page" class="nav-link">Todo</a>
        <a href="/trello_page" class="nav-link active">Trello</a>
    </nav>
    <div id="storage-container" style="margin: 0px 100px;">
        <span id="storage-counter">0 / 0 MB</span>
        <div id="storage-bar-bg">
            <div id="storage-bar-fill"></div>
        </div>
    </div>
    <div id="profile-pic" class="profile-pic no-picture"></div>
</header>
      
<nav id="mobileSubHeader" class="mobile-sub-header">
    <a href="/index" class="nav-link">Notes</a>
    <a href="/scheduler-page" class="nav-link">Calendar</a>
    <a href="/todo_page" class="nav-link">Todo</a>
    <a href="/trello_page" class="nav-link active">Trello</a>
</nav>

<div id="storage-modal" role="dialog" aria-hidden="true">
    <div class="panel" role="document">
        <div class="header">
        <div class="logo-badge">FUTURE NOTES</div>
        <div style="flex:1">
            <div class="big">Your storage â€” make it bigger!</div>
            <div style="opacity:0.8">Store notes, files, memories. Invite friends to grow your quota.</div>
        </div>
        <div><button id="storage-modal-close" class="btn">âœ•</button></div>
        </div>

        <div class="advert">Invite friends â†’ get <strong>+5MB</strong> per verified signup. Limit: <span id="per-day-limit">3</span>/day. <span style="margin-left:12px">ðŸŽ‰</span></div>

        <div class="invites">
        <div class="left">
            <h4>Current storage</h4>
            <div style="display:flex; align-items:center; gap:12px;">
            <div style="flex:1; background:#222; height:18px; border-radius:12px; padding:3px;">
                <div id="storage-bar-fill-modal" style="width:0%; height:100%; border-radius:9px; background:linear-gradient(90deg,#ffd166,#ff8a00);"></div>
            </div>
            <div id="storage-counter-modal">0 / 0 MB</div>
            </div>

            <div style="margin-top:12px;">
            <h4>Invite someone</h4>
            <div>Remaining invites today: <strong id="remaining-today">3</strong></div>
            <div class="input-row">
                <input id="invite-email" type="email" placeholder="friend@example.com" style="flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#0f0f0f; color:white;">
                <button id="send-invite-btn" class="btn primary">Send Invite</button>
            </div>
            <div id="invite-feedback" style="margin-top:8px; color:#f1c40f;"></div>
            </div>
        </div>

        <div class="right">
            <h4>Pending invites</h4>
            <div class="pending-list" id="pending-invites-list">
            <div style="opacity:0.6">Loading...</div>
            </div>

            <h4 style="margin-top:12px;">Daily stats</h4>
            <div>Sent today: <strong id="sent-today">0</strong></div>
        </div>
        </div>
    </div>
</div>

<div class="app-wrap">
    <aside class="sidebar">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <h3>Your Boards</h3>
            <div>
                <button id="create-board-btn" class="small-btn">+ Board</button>
            </div>
        </div>

        <div class="boards-list" id="boards-list">
            <!-- list of boards - intentionally not populated on initial start page load -->
        </div>
    </aside>

    <main class="main">
        <!-- Start page container (shows when no board is open) -->
        <div id="start-page" class="start-page" style="display:block;">
            <h2>All boards</h2>
            <div id="start-grid" class="start-grid">
                <!-- populated by loadStartPageBoards() -->
            </div>
        </div>

        <!-- Board area (hidden until a board is opened) -->
        <div id="board-area" style="display:none; flex:1; flex-direction:column;">
            <div class="board-header">
                <div class="board-title" id="board-title">Select a board</div>
                <div>
                    <button id="rename-board-btn" class="small-btn" style="display:none">Rename</button>
                    <button id="delete-board-btn" class="small-btn" style="display:none">Delete</button>
                </div>
            </div>

            <div class="lists-wrap" id="lists-wrap">
                <!-- lists (columns) inserted here -->
            </div>
        </div>

    </main>
</div>

<button class="floating-add" id="floating-add">ï¼‹</button>

<!-- Modals (kept but not used for create/rename flows) -->
<div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
        <h3 id="modal-title">Add</h3>
        <div class="modal-body">
            <input id="modal-input" placeholder="Title">
        </div>
        <div class="actions">
            <button id="modal-cancel" class="small-btn">Cancel</button>
            <button id="modal-ok" class="small-btn" style="background:var(--accent); color:#111;">OK</button>
        </div>
    </div>
</div>

<script>
/* Global state */
let currentBoardId = null;
let boardsCache = []; // list of boards

document.addEventListener("DOMContentLoaded", async () => {
    // Ensure fetch sends cookies
    if (!window.__fetchPatched) {
        const _f = window.fetch;
        window.fetch = (url, opts = {}) => {
            opts.credentials = 'include';
            return _f(url, opts);
        };
        window.__fetchPatched = true;
    }

    // Ping to check session
    async function validateSession() {
        try {
            const res = await fetch("/test-session", { method: "GET" });
            if (res.status === 200) {
                updateStorageCounter();
                loadUserProfile();
                return true;
            }
            if (res.status === 403) {
                window.location.href = '/login_page?suspended=true';
                return false;
            }
            return false;
        } catch (err) {
            return false;
        }
    }

    // Try auto-login
    async function attemptAutoLogin() {
        try {
            const res = await fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({}),
                credentials: 'include'
            });
            if (res.ok) {
                updateStorageCounter();
                loadUserProfile();
                return true;
            }
            // redirect to login page
            window.location.href = '/login_page?suspend=true';
            return false;
        } catch (err) {
            // redirect
            window.location.href = '/login_page?suspend=true';
            return false;
        }
    }

    const ok = await validateSession();
    if (!ok) {
        await attemptAutoLogin();
    }

    // initial start page load: fetch boards and render start page cards
    await loadStartPageBoards();

    // if URL contains a hash like #board-123 -> load that board immediately
    const hashMatch = location.hash.match(/^#board-(\d+)$/);
    if (hashMatch) {
        // populate sidebar and then open board
        await loadBoards();
        const id = parseInt(hashMatch[1], 10);
        // only select if that board actually exists
        if (boardsCache.some(b => b.id === id)) {
            await selectBoard(id);
        } else {
            // fallback: show start page
            showStartPage();
        }
    }

    // board rename/delete header buttons handlers
    document.getElementById('rename-board-btn').addEventListener('click', () => {
        const b = boardsCache.find(x => x.id === currentBoardId);
        if (!b) return;
        inlineRenameBoard(b.id, b.title);
    });
    document.getElementById('delete-board-btn').addEventListener('click', async () => {
        if (!currentBoardId) return;
        if (!confirm('Delete board and everything inside?')) return;
        const res = await apiDELETE(`/api/boards/${currentBoardId}`);
        if (res.ok) {
            currentBoardId = null;
            document.getElementById('board-title').textContent = 'Select a board';
            document.getElementById('lists-wrap').innerHTML = '';
            // update URL and show start page
            location.hash = '';
            await loadStartPageBoards();
            showStartPage();
            // refresh sidebar list
            await loadBoards();
        } else {
            const j = await res.json();
            alert(j.error || 'Failed');
        }
    });

    // respond to hash changes (allow navigation between boards without reload)
    window.addEventListener('hashchange', async () => {
        const m = location.hash.match(/^#board-(\d+)$/);
        if (!m) {
            // show start
            currentBoardId = null;
            document.getElementById('board-title').textContent = 'Select a board';
            document.getElementById('lists-wrap').innerHTML = '';
            showStartPage();
            return;
        }
        const id = parseInt(m[1], 10);
        // ensure sidebar is populated
        if (!boardsCache || boardsCache.length === 0) await loadBoards();
        if (boardsCache.some(b => b.id === id)) {
            await selectBoard(id);
        } else {
            showStartPage();
        }
    });
});

/* Storage and profile */

async function updateStorageCounter() {
    try {
        const res = await fetch('/user/storage', { credentials: 'include' });
        if (!res.ok) throw new Error("Failed to fetch storage info");
        const data = await res.json();

        const barHeader = document.getElementById('storage-bar-fill');

        let usedText, totalText, percentUsed;

        if (data.unlimited) {
            usedText = "âˆž";
            totalText = "Unlimited";
            percentUsed = 100; // fill bar fully for effect
            barHeader.classList.add('infinite-storage');
        } else {
            usedText = (data.used_bytes / 1024 / 1024).toFixed(2);
            totalText = (data.total_bytes / 1024 / 1024).toFixed(2);
            percentUsed = Math.min((data.used_bytes / data.total_bytes) * 100, 100);
            barHeader.classList.remove('infinite-storage');
        }

        document.getElementById('storage-counter').textContent = `${usedText} / ${totalText} MB`;
        document.getElementById('storage-bar-fill').style.width = `${percentUsed}%`;

        if (percentUsed > 90 && !data.unlimited) {
            document.getElementById('storage-bar-fill').classList.add('almost-full');
        } else {
            document.getElementById('storage-bar-fill').classList.remove('almost-full');
        }
    } catch (err) {
        console.error(err);
    }
}

document.getElementById('storage-container').style.cursor = 'pointer';
document.getElementById('storage-container').addEventListener('click', openStorageModal);
document.getElementById('storage-modal-close').addEventListener('click', closeStorageModal);
document.getElementById('send-invite-btn').addEventListener('click', sendInvite)

async function openStorageModal(e){
    e && e.preventDefault();
    document.getElementById('storage-modal').style.display = 'flex';
    await refreshModalData();
}

function closeStorageModal(){
    document.getElementById('storage-modal').style.display = 'none';
    document.getElementById('invite-feedback').textContent = '';
}

async function refreshModalData() {
    try {
        const res = await fetch('/invites/status', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load status');
        const data = await res.json();

        const barModal = document.getElementById('storage-bar-fill-modal');

        let usedText, totalText, percent;

        if (data.total_mb === null || data.storage_message) {
            usedText = "âˆž";
            totalText = "Unlimited";
            percent = 100; // fill bar fully for effect
            barModal.classList.add('infinite-storage');
        } else {
            usedText = data.used_mb.toFixed(2);
            totalText = data.total_mb.toFixed(2);
            percent = Math.min((data.used_mb / Math.max(data.total_mb, 1)) * 100, 100);
            barModal.classList.remove('infinite-storage');
        }

        document.getElementById('storage-counter-modal').textContent = `${usedText} / ${totalText} MB`;
        document.getElementById('storage-bar-fill-modal').style.width = percent + '%';

        if (percent > 90 && !(data.total_mb === null || data.storage_message)) {
            barModal.classList.add('almost-full');
        } else {
            barModal.classList.remove('almost-full');
        }

        document.getElementById('remaining-today').textContent = data.remaining_today;
        document.getElementById('sent-today').textContent = data.sent_today;
        document.getElementById('per-day-limit').textContent = data.per_day_limit;

        const pendingList = document.getElementById('pending-invites-list');
        pendingList.innerHTML = '';
        if (!data.pending_invites || data.pending_invites.length === 0) {
            pendingList.innerHTML = '<div style="opacity:0.6">No pending invites</div>';
        } else {
            for (const p of data.pending_invites) {
                const el = document.createElement('div');
                el.style.padding = '8px';
                el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                el.innerHTML = `<div style="font-weight:700">${p.email}</div>
                                <div style="opacity:0.6; font-size:12px">Sent ${new Date(p.created_at).toLocaleString()}</div>
                                <button onclick="cancelInvite('${p.id}')" class="cancel-invite-btn">Cancel</button>`;
                pendingList.appendChild(el);
            }
        }
    } catch (err) {
        console.error(err);
        document.getElementById('invite-feedback').textContent = 'Could not load invite status.';
    }
}


async function sendInvite(){
    const email = document.getElementById('invite-email').value.trim();
    if (!email) {
        document.getElementById('invite-feedback').textContent = 'Enter an email first.';
        return;
    }
    document.getElementById('send-invite-btn').disabled = true;
    document.getElementById('invite-feedback').textContent = 'Sending...';

    try {
        const res = await fetch('/invites/send', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({email}),
        credentials: 'include'
        });
        const j = await res.json();
        if (!res.ok) {
        document.getElementById('invite-feedback').textContent = j.error || 'Failed to send';
        } else {
        document.getElementById('invite-feedback').textContent = 'Invite sent! They must sign up via the link to redeem.';
        document.getElementById('invite-email').value = '';
        // refresh
        await refreshModalData();
        }
    } catch (err) {
        console.error(err);
        document.getElementById('invite-feedback').textContent = 'Network error';
    } finally {
        document.getElementById('send-invite-btn').disabled = false;
    }
}

/* Mobile nav toggle */
document.addEventListener("DOMContentLoaded", function() {
    const toggleButton = document.getElementById("toggle-mobile-nav");
    const mobileNav = document.getElementById("mobileSubHeader");

    toggleButton.addEventListener("click", function() {
        if (mobileNav.style.display === "block") {
            mobileNav.style.display = "none";
        } else {
            mobileNav.style.display = "block";
        }
    });
});

document.getElementById("profile-pic").addEventListener("click", () => {
    window.location.href = "/account_page";
});


async function loadUserProfile() {
    try {
        const userInfoResponse = await fetch("/user-info", { credentials: 'include' });
        if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            const profilePicElement = document.getElementById("profile-pic");
            
            if (userInfo.profile_picture) {
                const correctedProfilePic = userInfo.profile_picture.replace(/\\/g, "/");
                profilePicElement.style.backgroundImage = `url(${correctedProfilePic})`;
                profilePicElement.classList.remove("no-picture");
                profilePicElement.textContent = "";
            } else {
                profilePicElement.textContent = userInfo.username[0].toUpperCase();
                profilePicElement.classList.add("no-picture");
            }
        }
    } catch (error) {
        console.error("Error loading user profile:", error);
    }
}

/* API helpers */
async function apiGET(path) {
    const res = await fetch(path, { credentials: 'include' });
    if (!res.ok) throw res;
    return await res.json();
}
async function apiPOST(path, body) {
    const res = await fetch(path, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    return res;
}
async function apiPATCH(path, body) {
    const res = await fetch(path, { method:'PATCH', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    return res;
}
async function apiDELETE(path) {
    const res = await fetch(path, { method:'DELETE', credentials:'include' });
    return res;
}

/* START PAGE: fetch boards and render as cards */
async function loadStartPageBoards() {
    try {
        // reuse same API used by sidebar; keep in memory
        boardsCache = await apiGET('/api/boards');
        const grid = document.getElementById('start-grid');
        grid.innerHTML = '';

        if (!boardsCache || boardsCache.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'board-card create-large';
            empty.innerHTML = `<div style="text-align:center; width:100%"><div style="font-size:36px;">ï¼‹</div><div style="opacity:0.8; margin-top:8px">Create your first board</div></div>`;
            empty.addEventListener('click', () => {
                // open inline new board input (will create board)
                showInlineNewBoard();
            });
            grid.appendChild(empty);
            return;
        }

        for (const b of boardsCache) {
            const card = document.createElement('div');
            card.className = 'board-card';
            card.dataset.boardId = b.id;
            card.innerHTML = `<h3>${escapeHtml(b.title)}</h3><p>${b.cards_count ? `${b.cards_count} cards` : ''}</p>`;
            card.addEventListener('click', async () => {
                // when a board card is clicked, populate the sidebar and open the board
                await loadBoards();
                await selectBoard(b.id);
            });
            grid.appendChild(card);
        }

    } catch (err) {
        console.error('Failed to load start page boards', err);
        const grid = document.getElementById('start-grid');
        grid.innerHTML = '<div style="opacity:0.6">Failed to load boards</div>';
    }
}

function showStartPage() {
    document.getElementById('start-page').style.display = 'block';
    document.getElementById('board-area').style.display = 'none';
}
function hideStartPage() {
    document.getElementById('start-page').style.display = 'none';
    document.getElementById('board-area').style.display = 'flex';
}

/* Load boards for sidebar */
async function loadBoards() {
    try {
        boardsCache = await apiGET('/api/boards');
        const list = document.getElementById('boards-list');
        list.innerHTML = '';
        for (const b of boardsCache) {
            const el = document.createElement('div');
            el.className = 'board-item';
            el.dataset.boardId = b.id;
            el.innerHTML = `<div style="display:flex;gap:8px;align-items:center;"><div class="board-title-text">${escapeHtml(b.title)}</div></div>
                            <div class="board-actions">
                                <button class="small-btn rename-board" title="Rename">âœŽ</button>
                                <button class="small-btn delete-board" title="Delete">ðŸ—‘</button>
                            </div>`;
            // single click selects
            el.addEventListener('click', (e) => {
                if (e.target.closest('.rename-board') || e.target.closest('.delete-board')) return;
                selectBoard(b.id);
            });
            // double click to inline rename
            el.addEventListener('dblclick', (e) => {
                if (e.target.closest('.rename-board') || e.target.closest('.delete-board')) return;
                inlineRenameBoard(b.id, b.title);
            });
            el.querySelector('.rename-board').addEventListener('click', (ev) => {
                ev.stopPropagation();
                inlineRenameBoard(b.id, b.title);
            });
            el.querySelector('.delete-board').addEventListener('click', async (ev) => {
                ev.stopPropagation();
                if (!confirm('Delete board and all its lists/cards?')) return;
                const res = await apiDELETE(`/api/boards/${b.id}`);
                if (res.ok) {
                    if (b.id === currentBoardId) {
                        currentBoardId = null;
                        document.getElementById('board-title').textContent = 'Select a board';
                        document.getElementById('lists-wrap').innerHTML = '';
                    }
                    await loadBoards();
                    await loadStartPageBoards();
                } else {
                    const j = await res.json();
                    alert(j.error || 'Failed to delete');
                }
            });
            list.appendChild(el);
        }

        // do not auto-select any board here - selection happens only when user clicks a card or loads via hash
        highlightActiveBoard();
    } catch (err) {
        console.error(err);
    }
}

function highlightActiveBoard() {
    document.querySelectorAll('.board-item').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.boardId,10) === currentBoardId);
    });
    document.getElementById('rename-board-btn').style.display = currentBoardId ? 'inline-block' : 'none';
    document.getElementById('delete-board-btn').style.display = currentBoardId ? 'inline-block' : 'none';
}

/* Inline board create / rename UI */
document.getElementById('create-board-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    showInlineNewBoard();
});

/* ---------- Inline Add/Edit for Boards ---------- */

// Sidebar: Add an input at the bottom of the boards list for new board
const boardsListContainer = document.getElementById('boards-list');

// Add the inline input if it doesn't exist
if (!document.getElementById('new-board-input')) {
    const inputWrapper = document.createElement('div');
    inputWrapper.style.marginTop = '12px';
    inputWrapper.innerHTML = `<input id="new-board-input" placeholder="+ Add board" style="width:100%; padding:8px; border-radius:6px; background:var(--btn-color); border:1px solid #333; color:#e0e0e0;">`;
    boardsListContainer.appendChild(inputWrapper);

    const input = inputWrapper.querySelector('#new-board-input');
    input.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const title = input.value.trim();
            if (!title) return;
            input.disabled = true;
            try {
                const res = await apiPOST('/api/boards', { title });
                if (res.ok) {
                    // attempt to parse created board
                    let created = null;
                    try { created = await res.json(); } catch(e){}
                    await loadBoards();
                    await loadStartPageBoards();
                    if (created && created.id) {
                        location.hash = `#board-${created.id}`;
                        await selectBoard(created.id);
                    }
                } else {
                    const j = await res.json();
                    alert(j.error || 'Failed to create board');
                }
            } catch (err) {
                console.error(err);
            } finally {
                input.disabled = false;
                input.value = '';
            }
        }
    });
}

/* ---------- Inline Editing for Boards ---------- */
async function enableBoardInlineEdit(boardEl, boardId) {
    const titleEl = boardEl.querySelector('div:first-child div');
    const currentTitle = titleEl.textContent;
    const input = document.createElement('input');
    input.value = currentTitle;
    input.style.width = '100%';
    input.style.padding = '4px 6px';
    input.style.borderRadius = '6px';
    input.style.border = '1px solid #333';
    input.style.backgroundColor = 'var(--btn-color)';
    input.style.color = '#e0e0e0';
    titleEl.replaceWith(input);
    input.focus();

    input.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const newTitle = input.value.trim();
            if (!newTitle) return;
            const res = await apiPATCH(`/api/boards/${boardId}`, { title: newTitle });
            if (res.ok) {
                await loadBoards();
            } else {
                const j = await res.json();
                alert(j.error || 'Failed');
            }
        }
    });

    input.addEventListener('blur', async () => {
        await loadBoards();
    });
}

/* Attach double-click edit on boards */
function attachBoardEditHandlers() {
    document.querySelectorAll('.board-item > div:first-child').forEach(div => {
        const boardId = parseInt(div.closest('.board-item').dataset.boardId, 10);
        div.ondblclick = () => enableBoardInlineEdit(div.closest('.board-item'), boardId);
    });
}

// Make sure after loadBoards we reattach the inline edit
const originalLoadBoards = loadBoards;
loadBoards = async function() {
    await originalLoadBoards();
    attachBoardEditHandlers();
};


function showInlineNewBoard() {
    const list = document.getElementById('boards-list');
    // avoid duplicate input
    if (document.getElementById('inline-new-board')) {
        document.getElementById('inline-new-board-input').focus();
        return;
    }
    const container = document.createElement('div');
    container.id = 'inline-new-board';
    container.className = 'board-item';
    container.innerHTML = `<div style="display:flex;gap:8px;align-items:center;">
        <input id="inline-new-board-input" placeholder="New board title" style="width:100%; padding:6px; border-radius:6px; border:1px solid #333; background:var(--btn-color); color:#e0e0e0;" />
    </div><div class="board-actions"><button class="small-btn" id="inline-new-board-cancel">âœ•</button></div>`;
    list.prepend(container);
    const input = document.getElementById('inline-new-board-input');
    input.focus();
    input.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            const title = input.value.trim();
            if (!title) return;
            const res = await apiPOST('/api/boards', { title });
            if (res.ok) {
                // try to get created board id
                let created = null;
                try { created = await res.json(); } catch(e){}
                await loadBoards();
                await loadStartPageBoards();
                if (created && created.id) {
                    location.hash = `#board-${created.id}`;
                    await selectBoard(created.id);
                }
            } else {
                const j = await res.json();
                alert(j.error || 'Failed to create board');
            }
            removeInlineNewBoard();
        } else if (ev.key === 'Escape') {
            removeInlineNewBoard();
        }
    });
    document.getElementById('inline-new-board-cancel').addEventListener('click', removeInlineNewBoard);
    input.addEventListener('blur', () => {
        // short timeout so Enter doesn't trigger immediate removal before submission
        setTimeout(() => {
            if (document.activeElement !== input) removeInlineNewBoard();
        }, 150);
    });
}

function removeInlineNewBoard() {
    const el = document.getElementById('inline-new-board');
    if (el) el.remove();
}

/* ---------- Inline rename for boards ---------- */
async function inlineRenameBoard(boardId, currentTitle) {
    const boardEl = document.querySelector(`.board-item[data-board-id="${boardId}"]`);
    if (!boardEl) return;
    // avoid creating multiple editors
    if (boardEl.querySelector('.inline-board-edit')) {
        boardEl.querySelector('input.inline-board-input')?.focus();
        return;
    }
    const titleDiv = boardEl.querySelector('.board-title-text');
    const original = titleDiv.textContent;
    titleDiv.style.display = 'none';
    const input = document.createElement('input');
    input.className = 'inline-board-input inline-board-edit';
    input.value = currentTitle;
    input.style.padding = '6px';
    input.style.borderRadius = '6px';
    input.style.border = '1px solid #333';
    input.style.background = 'var(--btn-color)';
    input.style.color = '#e0e0e0';
    input.style.width = '160px';
    titleDiv.parentElement.prepend(input);
    input.focus();
    input.select();

    input.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            const title = input.value.trim();
            if (!title) return;
            const res = await apiPATCH(`/api/boards/${boardId}`, { title });
            if (res.ok) {
                await loadBoards();
                if (currentBoardId === boardId) document.getElementById('board-title').textContent = title;
            } else {
                const j = await res.json();
                alert(j.error || 'Failed to rename');
            }
        } else if (ev.key === 'Escape') {
            // cancel
            cleanup();
        }
    });

    input.addEventListener('blur', cleanup);

    function cleanup() {
        input.remove();
        titleDiv.style.display = '';
    }
}

/* Select board */
async function selectBoard(boardId) {
    currentBoardId = boardId;
    const board = boardsCache.find(b => b.id === boardId);
    document.getElementById('board-title').textContent = board ? board.title : 'Select a board';
    highlightActiveBoard();
    // update URL hash (doesn't reload page)
    location.hash = `#board-${boardId}`;
    // show board area and hide start page
    hideStartPage();
    // load lists for that board
    await loadLists(boardId);
}

/* Floating add button -> create list inline within current board */
document.getElementById('floating-add').addEventListener('click', () => {
    if (!currentBoardId) { alert('Select a board first'); return; }
    showInlineNewList();
});

function showInlineNewList() {
    const container = document.getElementById('lists-wrap');
    // avoid duplicate
    if (document.getElementById('inline-new-list')) {
        document.getElementById('inline-new-list-input').focus();
        return;
    }
    const col = document.createElement('div');
    col.id = 'inline-new-list';
    col.className = 'list';
    col.innerHTML = `<h4><span><input id="inline-new-list-input" placeholder="New list title" style="width:100%; padding:6px; border-radius:6px; border:1px solid #333; background:var(--btn-color); color:#e0e0e0;" /></span>
                    <span style="display:flex;gap:6px;">
                    <button class="small-btn" id="inline-new-list-cancel">âœ•</button>
                    </span></h4>
                    <div class="card-list" id="cards-for-inline-new"></div>`;
    container.prepend(col);
    const input = document.getElementById('inline-new-list-input');
    input.focus();
    input.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            const title = input.value.trim();
            if (!title) return;
            const res = await apiPOST('/api/lists', { title, board_id: currentBoardId });
            if (res.ok) {
                await loadLists(currentBoardId);
            } else {
                const j = await res.json();
                alert(j.error || 'Failed to create list');
            }
            removeInlineNewList();
        } else if (ev.key === 'Escape') {
            removeInlineNewList();
        }
    });
    document.getElementById('inline-new-list-cancel').addEventListener('click', removeInlineNewList);
    input.addEventListener('blur', () => {
        setTimeout(() => {
            if (document.activeElement !== input) removeInlineNewList();
        }, 150);
    });
}

function removeInlineNewList() {
    const el = document.getElementById('inline-new-list');
    if (el) el.remove();
}

/* Load lists for the given board */
async function loadLists(boardId) {
    try {
        const lists = await apiGET(`/api/lists?board_id=${boardId}`);
        const container = document.getElementById('lists-wrap');
        container.innerHTML = '';
        for (const l of lists) {
            const col = document.createElement('div');
            col.className = 'list';
            col.dataset.listId = l.id;
            col.innerHTML = `<h4><span class="list-title-text">${escapeHtml(l.title)}</span>
                <span style="display:flex;gap:6px;">
                    <button class="small-btn rename-list" title="Rename">âœŽ</button>
                    <button class="small-btn delete-list" title="Delete">ðŸ—‘</button>
                </span></h4>
                <div class="card-list" id="cards-for-${l.id}"></div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <input placeholder="Card title" id="new-card-${l.id}" style="flex:1; padding:8px; border-radius:6px; background:var(--btn-color); border:1px solid #333; color:#e0e0e0;">
                    <button class="small-btn add-card" data-list="${l.id}">Add</button>
                </div>`;
            container.appendChild(col);

            // attach rename-on-dblclick for list title
            const titleSpan = col.querySelector('.list-title-text');
            titleSpan.addEventListener('dblclick', () => inlineRenameList(l.id, l.title));

            // attach rename/delete handlers (rename now inline)
            col.querySelector('.rename-list').addEventListener('click', (ev) => {
                ev.stopPropagation();
                inlineRenameList(l.id, l.title);
            });
            col.querySelector('.delete-list').addEventListener('click', async (ev) => {
                ev.stopPropagation();
                if (!confirm('Delete list and its cards?')) return;
                const res = await apiDELETE(`/api/lists/${l.id}`);
                if (res.ok) {
                    await loadLists(boardId);
                } else {
                    const j = await res.json();
                    alert(j.error || 'Failed to delete list');
                }
            });

            const listEl = col.querySelector('.card-list');
            for (const c of l.cards) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.dataset.cardId = c.id;
                cardEl.innerHTML = `<div class="card-main">
                    <div style="font-weight:700" class="card-title-text">${escapeHtml(c.title)}</div>
                    <div class="meta card-desc-text">${escapeHtml(c.description || '')}</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <button class="small-btn edit-card" title="Edit">âœŽ</button>
                    <button class="small-btn delete-card" title="Delete">ðŸ—‘</button>
                </div>`;
                // edit handler - now inline toggle
                cardEl.querySelector('.edit-card').addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    inlineEditCard(c.id, c.title, c.description, boardId);
                });
                // double-click card to edit
                cardEl.addEventListener('dblclick', (ev) => {
                    if (ev.target.closest('.edit-card') || ev.target.closest('.delete-card')) return;
                    inlineEditCard(c.id, c.title, c.description, boardId);
                });
                // delete handler
                cardEl.querySelector('.delete-card').addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                    if (!confirm('Delete card?')) return;
                    const res = await apiDELETE(`/api/cards/${c.id}`);
                    if (res.ok) loadLists(boardId);
                    else {
                        const j = await res.json();
                        alert(j.error || 'Failed to delete card');
                    }
                });

                listEl.appendChild(cardEl);
            }
        }

        // attach new card handlers: Enter to add without clicking the "Add" button
        document.querySelectorAll('.add-card').forEach(btn => {
            const listId = btn.dataset.list;
            const inp = document.getElementById(`new-card-${listId}`);
            // Enter key adds
            inp.addEventListener('keydown', async (ev) => {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    const title = inp.value.trim();
                    if (!title) return;
                    btn.disabled = true;
                    const res = await apiPOST('/api/cards', { title, list_id: parseInt(listId,10) });
                    btn.disabled = false;
                    if (res.ok) {
                        inp.value = '';
                        await loadLists(boardId);
                    } else {
                        const j = await res.json();
                        alert(j.error || 'Failed to create card');
                    }
                } else if (ev.key === 'Escape') {
                    inp.value = '';
                    inp.blur();
                }
            });
            // existing click behavior still works
            btn.addEventListener('click', async () => {
                const title = inp.value.trim();
                if (!title) return;
                btn.disabled = true;
                const res = await apiPOST('/api/cards', { title, list_id: parseInt(listId,10) });
                btn.disabled = false;
                if (res.ok) {
                    inp.value = '';
                    await loadLists(boardId);
                } else {
                    const j = await res.json();
                    alert(j.error || 'Failed to create card');
                }
            });
        });

        // Make lists sortable (cards draggable) and update order on end
        document.querySelectorAll('.card-list').forEach(list => {
            new Sortable(list, {
                group: 'boards',
                animation: 150,
                onEnd: async function (evt) {
                    const toList = evt.to;
                    const toListEl = toList.closest('.list');
                    const listId = parseInt(toListEl.dataset.listId, 10);
                    const cardIds = Array.from(toList.children).map(c => parseInt(c.dataset.cardId, 10));
                    const movedCardId = parseInt(evt.item.dataset.cardId, 10);
                    try {
                        const res = await apiPOST('/api/cards/move', {
                            card_id: movedCardId,
                            to_list_id: listId,
                            order_in_list: cardIds
                        });
                        if (!res.ok) {
                            const j = await res.json();
                            console.error('Move failed', j);
                            await loadLists(boardId);
                        } else {
                            await loadLists(boardId);
                        }
                    } catch (err) {
                        console.error(err);
                        await loadLists(boardId);
                    }
                }
            });
        });

    } catch (err) {
        console.error(err);
    }
}

/* Inline rename list */
function inlineRenameList(listId, currentTitle) {
    const listEl = document.querySelector(`.list[data-list-id="${listId}"]`);
    if (!listEl) return;
    const titleSpan = listEl.querySelector('.list-title-text');
    if (!titleSpan) return;
    if (listEl.querySelector('.inline-list-edit')) {
        listEl.querySelector('.inline-list-input')?.focus();
        return;
    }
    titleSpan.style.display = 'none';
    const input = document.createElement('input');
    input.className = 'inline-list-input inline-list-edit';
    input.value = currentTitle;
    input.style.padding = '6px';
    input.style.borderRadius = '6px';
    input.style.border = '1px solid #333';
    input.style.background = 'var(--btn-color)';
    input.style.color = '#e0e0e0';
    input.style.width = '160px';
    titleSpan.parentElement.prepend(input);
    input.focus();
    input.select();

    input.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            const title = input.value.trim();
            if (!title) return;
            const res = await apiPATCH(`/api/lists/${listId}`, { title });
            if (res.ok) {
                await loadLists(currentBoardId);
            } else {
                const j = await res.json();
                alert(j.error || 'Failed to rename list');
            }
        } else if (ev.key === 'Escape') {
            cleanup();
        }
    });
    input.addEventListener('blur', cleanup);
    function cleanup() {
        input.remove();
        titleSpan.style.display = '';
    }
}

/* Inline edit card */
function inlineEditCard(cardId, currentTitle, currentDesc, boardId) {
    const cardEl = document.querySelector(`.card[data-card-id="${cardId}"]`);
    if (!cardEl) return;
    if (cardEl.querySelector('.inline-card-edit')) {
        cardEl.querySelector('.inline-card-title')?.focus();
        return;
    }
    const main = cardEl.querySelector('.card-main');
    const actions = cardEl.querySelector('div:last-child');
    main.style.display = 'none';
    actions.style.display = 'none';

    const editor = document.createElement('div');
    editor.className = 'inline-card-edit';
    editor.style.display = 'flex';
    editor.style.flexDirection = 'column';
    editor.style.gap = '6px';
    editor.innerHTML = `
        <input class="inline-card-title" value="${escapeHtml(currentTitle)}" style="padding:6px; border-radius:6px; border:1px solid #333; background:var(--btn-color); color:#e0e0e0;">
        <input class="inline-card-desc" value="${escapeHtml(currentDesc||'')}" style="padding:6px; border-radius:6px; border:1px solid #333; background:var(--btn-color); color:#e0e0e0;">
    `;
    cardEl.prepend(editor);
    const titleInput = editor.querySelector('.inline-card-title');
    const descInput = editor.querySelector('.inline-card-desc');
    titleInput.focus();
    titleInput.select();

    async function save() {
        const title = titleInput.value.trim();
        const description = descInput.value.trim();
        if (!title) return;
        const res = await apiPATCH(`/api/cards/${cardId}`, { title, description });
        if (res.ok) {
            await loadLists(boardId);
        } else {
            const j = await res.json();
            alert(j.error || 'Failed to update card');
            cleanup();
        }
    }

    function cleanup() {
        editor.remove();
        main.style.display = '';
        actions.style.display = '';
    }

    titleInput.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            await save();
        } else if (ev.key === 'Escape') {
            cleanup();
        }
    });
    descInput.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
            await save();
        } else if (ev.key === 'Escape') {
            cleanup();
        }
    });
    titleInput.addEventListener('blur', () => {
        // give a small delay to allow pressing Enter to register
        setTimeout(() => {
            if (document.activeElement !== titleInput && document.activeElement !== descInput) cleanup();
        }, 200);
    });
}

/* Utility */
function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]);
}

/* initial setup for boards loaded earlier also ensures event attachments */
/* cancel modal overlay bindings for old modal (kept in DOM but not used heavily) */
document.getElementById('modal-cancel').addEventListener('click', () => {
    document.getElementById('modal-overlay').style.display = 'none';
});
document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-overlay')) document.getElementById('modal-overlay').style.display = 'none';
});
</script>
</body>
</html>
